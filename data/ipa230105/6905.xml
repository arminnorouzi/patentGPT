<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE us-patent-application SYSTEM "us-patent-application-v46-2022-02-17.dtd" [ ]><us-patent-application lang="EN" dtd-version="v4.6 2022-02-17" file="US20230006906A1-20230105.XML" status="PRODUCTION" id="us-patent-application" country="US" date-produced="20221221" date-publ="20230105"><us-bibliographic-data-application lang="EN" country="US"><publication-reference><document-id><country>US</country><doc-number>20230006906</doc-number><kind>A1</kind><date>20230105</date></document-id></publication-reference><application-reference appl-type="utility"><document-id><country>US</country><doc-number>17940189</doc-number><date>20220908</date></document-id></application-reference><us-application-series-code>17</us-application-series-code><priority-claims><priority-claim sequence="01" kind="national"><country>CN</country><doc-number>202010161932.X</doc-number><date>20200310</date></priority-claim><priority-claim sequence="02" kind="national"><country>CN</country><doc-number>202010236422.4</doc-number><date>20200330</date></priority-claim></priority-claims><classifications-ipcr><classification-ipcr><ipc-version-indicator><date>20060101</date></ipc-version-indicator><classification-level>A</classification-level><section>H</section><class>04</class><subclass>L</subclass><main-group>43</main-group><subgroup>0852</subgroup><symbol-position>F</symbol-position><classification-value>I</classification-value><action-date><date>20230105</date></action-date><generating-office><country>US</country></generating-office><classification-status>B</classification-status><classification-data-source>H</classification-data-source></classification-ipcr><classification-ipcr><ipc-version-indicator><date>20060101</date></ipc-version-indicator><classification-level>A</classification-level><section>H</section><class>04</class><subclass>L</subclass><main-group>47</main-group><subgroup>34</subgroup><symbol-position>L</symbol-position><classification-value>I</classification-value><action-date><date>20230105</date></action-date><generating-office><country>US</country></generating-office><classification-status>B</classification-status><classification-data-source>H</classification-data-source></classification-ipcr></classifications-ipcr><classifications-cpc><main-cpc><classification-cpc><cpc-version-indicator><date>20130101</date></cpc-version-indicator><section>H</section><class>04</class><subclass>L</subclass><main-group>43</main-group><subgroup>0852</subgroup><symbol-position>F</symbol-position><classification-value>I</classification-value><action-date><date>20230105</date></action-date><generating-office><country>US</country></generating-office><classification-status>B</classification-status><classification-data-source>H</classification-data-source><scheme-origination-code>C</scheme-origination-code></classification-cpc></main-cpc><further-cpc><classification-cpc><cpc-version-indicator><date>20130101</date></cpc-version-indicator><section>H</section><class>04</class><subclass>L</subclass><main-group>47</main-group><subgroup>34</subgroup><symbol-position>L</symbol-position><classification-value>I</classification-value><action-date><date>20230105</date></action-date><generating-office><country>US</country></generating-office><classification-status>B</classification-status><classification-data-source>H</classification-data-source><scheme-origination-code>C</scheme-origination-code></classification-cpc></further-cpc></classifications-cpc><invention-title id="d2e79">IN-SITU FLOW DETECTION METHOD AND APPARATUS</invention-title><us-related-documents><continuation><relation><parent-doc><document-id><country>US</country><doc-number>PCT/CN2021/079204</doc-number><date>20210305</date></document-id><parent-status>PENDING</parent-status></parent-doc><child-doc><document-id><country>US</country><doc-number>17940189</doc-number></document-id></child-doc></relation></continuation></us-related-documents><us-parties><us-applicants><us-applicant sequence="00" app-type="applicant" designation="us-only" applicant-authority-category="assignee"><addressbook><orgname>HUAWEI TECHNOLOGIES CO., LTD.</orgname><address><city>Shenzhen</city><country>CN</country></address></addressbook><residence><country>CN</country></residence></us-applicant></us-applicants><inventors><inventor sequence="00" designation="us-only"><addressbook><last-name>SHU</last-name><first-name>Qinghui</first-name><address><city>Dongguan</city><country>CN</country></address></addressbook></inventor><inventor sequence="01" designation="us-only"><addressbook><last-name>HUANG</last-name><first-name>Jinming</first-name><address><city>Dongguan</city><country>CN</country></address></addressbook></inventor><inventor sequence="02" designation="us-only"><addressbook><last-name>ZHOU</last-name><first-name>Tianran</first-name><address><city>Beijing</city><country>CN</country></address></addressbook></inventor><inventor sequence="03" designation="us-only"><addressbook><last-name>CHEN</last-name><first-name>Peng</first-name><address><city>Dongguan</city><country>CN</country></address></addressbook></inventor><inventor sequence="04" designation="us-only"><addressbook><last-name>GUO</last-name><first-name>Songsong</first-name><address><city>Wuhan</city><country>CN</country></address></addressbook></inventor><inventor sequence="05" designation="us-only"><addressbook><last-name>LI</last-name><first-name>Xiangzhen</first-name><address><city>Dongguan</city><country>CN</country></address></addressbook></inventor><inventor sequence="06" designation="us-only"><addressbook><last-name>TANG</last-name><first-name>Yan</first-name><address><city>Dongguan</city><country>CN</country></address></addressbook></inventor><inventor sequence="07" designation="us-only"><addressbook><last-name>ZHENG</last-name><first-name>Chengcong</first-name><address><city>Dongguan</city><country>CN</country></address></addressbook></inventor></inventors></us-parties><assignees><assignee><addressbook><orgname>HUAWEI TECHNOLOGIES CO., LTD.</orgname><role>03</role><address><city>Shenzhen</city><country>CN</country></address></addressbook></assignee></assignees></us-bibliographic-data-application><abstract id="abstract"><p id="p-0001" num="0000">An in-situ flow detection method. When determining a transmission delay in a detection domain in a first in-situ flow detection period, a first network node may color a plurality of packets in a first service flow that are received by the first network node through a first inbound interface and determine the delay in the detection domain in the first in-situ flow detection period based on the plurality of colored packets, thereby improving the precision of the detected transmission delay in the detection domain.</p></abstract><drawings id="DRAWINGS"><figure id="Fig-EMI-D00000" num="00000"><img id="EMI-D00000" he="44.20mm" wi="156.38mm" file="US20230006906A1-20230105-D00000.TIF" alt="embedded image" img-content="drawing" img-format="tif"/></figure><figure id="Fig-EMI-D00001" num="00001"><img id="EMI-D00001" he="211.75mm" wi="131.57mm" orientation="landscape" file="US20230006906A1-20230105-D00001.TIF" alt="embedded image" img-content="drawing" img-format="tif"/></figure><figure id="Fig-EMI-D00002" num="00002"><img id="EMI-D00002" he="55.96mm" wi="158.41mm" file="US20230006906A1-20230105-D00002.TIF" alt="embedded image" img-content="drawing" img-format="tif"/></figure><figure id="Fig-EMI-D00003" num="00003"><img id="EMI-D00003" he="205.99mm" wi="152.82mm" file="US20230006906A1-20230105-D00003.TIF" alt="embedded image" img-content="drawing" img-format="tif"/></figure><figure id="Fig-EMI-D00004" num="00004"><img id="EMI-D00004" he="175.26mm" wi="130.81mm" file="US20230006906A1-20230105-D00004.TIF" alt="embedded image" img-content="drawing" img-format="tif"/></figure><figure id="Fig-EMI-D00005" num="00005"><img id="EMI-D00005" he="41.91mm" wi="132.25mm" file="US20230006906A1-20230105-D00005.TIF" alt="embedded image" img-content="drawing" img-format="tif"/></figure><figure id="Fig-EMI-D00006" num="00006"><img id="EMI-D00006" he="217.68mm" wi="159.85mm" file="US20230006906A1-20230105-D00006.TIF" alt="embedded image" img-content="drawing" img-format="tif"/></figure><figure id="Fig-EMI-D00007" num="00007"><img id="EMI-D00007" he="222.93mm" wi="112.52mm" file="US20230006906A1-20230105-D00007.TIF" alt="embedded image" img-content="drawing" img-format="tif"/></figure><figure id="Fig-EMI-D00008" num="00008"><img id="EMI-D00008" he="126.66mm" wi="125.81mm" file="US20230006906A1-20230105-D00008.TIF" alt="embedded image" img-content="drawing" img-format="tif"/></figure><figure id="Fig-EMI-D00009" num="00009"><img id="EMI-D00009" he="129.37mm" wi="125.81mm" file="US20230006906A1-20230105-D00009.TIF" alt="embedded image" img-content="drawing" img-format="tif"/></figure><figure id="Fig-EMI-D00010" num="00010"><img id="EMI-D00010" he="171.03mm" wi="125.81mm" file="US20230006906A1-20230105-D00010.TIF" alt="embedded image" img-content="drawing" img-format="tif"/></figure><figure id="Fig-EMI-D00011" num="00011"><img id="EMI-D00011" he="216.75mm" wi="94.74mm" file="US20230006906A1-20230105-D00011.TIF" alt="embedded image" img-content="drawing" img-format="tif"/></figure><figure id="Fig-EMI-D00012" num="00012"><img id="EMI-D00012" he="193.80mm" wi="105.07mm" file="US20230006906A1-20230105-D00012.TIF" alt="embedded image" img-content="drawing" img-format="tif"/></figure></drawings><description id="description"><?cross-reference-to-related-applications description="Cross Reference To Related Applications" end="lead"?><heading id="h-0001" level="1">CROSS-REFERENCE TO RELATED APPLICATIONS</heading><p id="p-0002" num="0001">This application is a continuation of International Application No. PCT/CN2021/079204, filed on Mar. 5, 2021, which claims priorities to Chinese Patent Application No. 202010161932.X, filed on Mar. 10, 2020 and Chinese Patent Application No. 202010236422.4, filed on Mar. 30, 2020. All of the aforementioned applications are hereby incorporated by reference in their entireties.</p><?cross-reference-to-related-applications description="Cross Reference To Related Applications" end="tail"?><?summary-of-invention description="Summary of Invention" end="lead"?><heading id="h-0002" level="1">TECHNICAL FIELD</heading><p id="p-0003" num="0002">The embodiments relate to the communication field, an in-situ flow detection method, and an apparatus.</p><heading id="h-0003" level="1">BACKGROUND</heading><p id="p-0004" num="0003">In a data communication network, a delay of the data communication network may be detected using an in-situ flow detection technology, for example, an in-situ flow information telemetry (iFIT) technology, to determine quality of service of the network.</p><p id="p-0005" num="0004">Currently, precision of the delay of the data communication network that is detected using the in-situ flow detection technology is not high, and consequently the quality of service of the network cannot be accurately evaluated. Therefore, a solution is required to resolve the foregoing problem.</p><heading id="h-0004" level="1">SUMMARY</heading><p id="p-0006" num="0005">The embodiments may provide an in-situ flow detection method, to improve precision of a detected delay of a data communication network.</p><p id="p-0007" num="0006">According to a first aspect, an embodiment may provide an in-situ flow detection method. The method may be performed by a first network node in a detection domain. When determining a transmission delay in the detection domain in a first in-situ flow detection period, the first network node may color a plurality of packets in a first service flow that are received by the first network node through a first inbound interface and determine the delay in the detection domain in the first in-situ flow detection period based on the plurality of colored packets. The first network node may receive each of the plurality of packets through the first inbound interface, and then the first network node encapsulates, into in-situ flow detection information of each received packet, a first timestamp at which each packet is received, and forwards each packet encapsulated with the first timestamp to a first outbound interface. The first timestamp of each packet indicates a moment at which the first network node receives each packet through the first inbound interface. That is, a first timestamp of a first packet indicates a moment at which the first network node receives the first packet through the first inbound interface. In this embodiment, when the transmission delay in the detection domain in the first in-situ flow detection period is determined, a plurality of packets, instead of one packet, in the first in-situ flow detection period are colored. When only one packet is colored, if packet loss occurs on the colored packet, the transmission delay in the detection domain in the first in-situ flow detection period cannot be determined. However, in the manner of coloring a plurality of packets, even if packet loss occurs on one or more of the packets, the transmission delay in the detection domain in the first in-situ flow detection period may be determined based on another packet on which no packet loss occurs. In addition, determining the transmission delay in the detection domain in the first in-situ flow detection period based on a plurality of packets has higher precision than determining the transmission delay in the detection domain in the first in-situ flow detection period based on one packet. In conclusion, using the solution provided in this embodiment may improve the precision of the detected transmission delay in the detection domain.</p><p id="p-0008" num="0007">In a possible implementation, the first network node colors each packet in the first service flow and determines the delay of the first service flow in the first in-situ flow detection period based on each colored packet. The plurality of packets received through the first inbound interface may be all packets received through the first inbound interface. Coloring each packet in the first service flow for delay detection can further improve transmission delay detection precision.</p><p id="p-0009" num="0008">In a possible implementation, the in-situ flow detection is if IT in-situ flow detection.</p><p id="p-0010" num="0009">In a possible implementation, the in-situ flow detection information includes indication information, and the indication information indicates that the in-situ flow detection is end-to-end per-packet in-situ flow detection and/or hop-by-hop per-packet in-situ flow detection.</p><p id="p-0011" num="0010">In a possible implementation, the plurality of packets in the first service flow that are received in the first in-situ flow detection period may include the first packet, and the first network node encapsulates the first timestamp of the first packet into the in-situ flow detection information of the first packet. During implementation, for example, the first network node may encapsulate the first timestamp of the first packet into a first flow instruction extension header FIEH of first iFIT in-situ flow detection information of the first packet.</p><p id="p-0012" num="0011">In a possible implementation, the first iFIT in-situ flow detection information further includes indication information, and the indication information indicates that the in-situ flow detection is end-to-end per-packet in-situ flow detection and/or hop-by-hop per-packet in-situ flow detection. After a node supporting an iFIT technology in the detection domain receives a packet including the first iFIT in-situ flow detection information, the node may determine, based on the indication information in the first iFIT in-situ flow detection information, a detection operation to be performed.</p><p id="p-0013" num="0012">In this embodiment, the end-to-end in-situ flow detection means that in-situ flow detection is performed from a network node to another network node. For example, a tail node may perform a step of detecting an end-to-end transmission delay from a head node to the tail node, or a transit node may perform a step of detecting an end-to-end transmission delay from the head node or any upstream node to the transit node. The per-packet in-situ flow detection means that the head node colors a plurality of packets in the first service flow. Correspondingly, the end-to-end transmission delay from the head node to the tail node that is calculated by the tail node is obtained through calculation based on the plurality of colored packets. The hop-by-hop in-situ flow detection means that each node that supports an in-situ flow detection technology and that receives the colored packet needs to perform in-situ flow detection on the transmission delay. The hop-by-hop per-packet in-situ flow detection means that each node supporting the in-situ flow detection performs in-situ flow detection on each received packet.</p><p id="p-0014" num="0013">In a possible implementation, for hop-by-hop per-packet in-situ flow detection, the first network node may receive, through the first outbound interface, each packet that is from the first inbound interface and that is encapsulated with the first timestamp. Both the first outbound interface and the first inbound interface are communication interfaces of the first network node, the first inbound interface is an interface through which the first network node communicates with an upstream node, and the first outbound interface is an interface through which the first network node communicates with a downstream node (namely, a second network node). To enable a downstream network node supporting the in-situ flow detection technology to calculate a transmission delay between the first network node and the downstream network node, the first network node may update the first timestamp of each of the plurality of packets to a second timestamp of each packet, and the second timestamp of each packet indicates a moment at which each packet is received through the first outbound interface. After updating the first timestamp of each packet to the second timestamp of each packet, the first network node may send, through the first outbound interface to the second network node, each packet encapsulated with the second timestamp. The first network node mentioned herein may be a head node or a transit node in the detection domain.</p><p id="p-0015" num="0014">In a possible implementation, if the indication information indicates the end-to-end per-packet in-situ flow detection and the hop-by-hop per-packet in-situ flow detection, to enable the transit node or the tail node in the detection domain to calculate an end-to-end transmission delay from the transit node or the tail node to the head node, after receiving, through the first outbound interface, each packet that is from the first inbound interface and that is encapsulated with the first timestamp, the first network node serving as the head node no longer replaces the first timestamp with the second timestamp when encapsulating the second timestamp of each packet into the in-situ flow detection information of each packet, instead, on the premise that the first timestamp is retained, the first network node encapsulates the second timestamp into the in-situ flow detection information of each packet. In other words, after the first network node encapsulates the second timestamp of each packet into the in-situ flow detection information of each packet, each packet carries both the first timestamp and the second timestamp. Then, the first network node may send, to the second network node through the first outbound interface, each packet encapsulated with the first timestamp and the second timestamp. In this way, the network node that supports the iFIT technology and that receives each packet can calculate the end-to-end delay between the network node and the head node, an internal transmission delay of the node, and a link transmission delay between two adjacent network nodes supporting the iFIT technology.</p><p id="p-0016" num="0015">In a possible implementation, the first network node may determine a transmission delay of each packet in the first network node based on the first timestamp of each packet and the second timestamp of each packet, and determine, based on the transmission delay of each packet in the first network node, a transmission delay of internal transmission of the first service flow in the first network node in the first in-situ flow detection period. Because the transmission delay of the internal transmission of the first service flow in the first network node in the first in-situ flow detection period is determined with reference to transmission delays of the plurality of packets in the first network node, accuracy is relatively high.</p><p id="p-0017" num="0016">In a possible implementation, for hop-by-hop per-packet in-situ flow detection, the first network node serving as a tail node may further perform the following steps: The first network node receives, through the first outbound interface, each packet that is encapsulated with the first timestamp and that is from the first inbound interface; the first network node determines a second timestamp of each packet, where the second timestamp of each packet indicates a moment at which each packet is received through the first outbound interface; the first network node determines, based on the first timestamp carried in each packet and the second timestamp of each packet, a transmission delay of each packet in the first network node; and the first network node determines, based on the transmission delay of each packet in the first network node, a transmission delay of internal transmission of the first service flow in the first network node in the first in-situ flow detection period. That is, the tail node in the detection domain may calculate a transmission delay of internal transmission of the first service flow in the tail node in the first in-situ flow detection period.</p><p id="p-0018" num="0017">In a possible implementation, after determining the transmission delay of internal transmission of the first service flow in the first network node in the first in-situ flow detection period, the first network node may further report the determined transmission delay to a controller, so that the controller analyzes the transmission delay to determine performance of the detection domain.</p><p id="p-0019" num="0018">In a possible implementation, it is considered that a maximum transmission delay of internal transmission of the first service flow in the first network node in the first in-situ flow detection period, a minimum transmission delay of internal transmission of the first service flow in the first network node in the first in-situ flow detection period, and an average transmission delay of internal transmission of the first service flow in the first network node in the first in-situ flow detection period can all reflect the transmission delay of internal transmission of the first service flow in the first network node in the first in-situ flow detection period. Therefore, the transmission delay of internal transmission of the first service flow in the first network node in the first in-situ flow detection period may include any one or more of the maximum transmission delay of internal transmission of the first service flow in the first network node in the first in-situ flow detection period, the minimum transmission delay of internal transmission of the first service flow in the first network node in the first in-situ flow detection period, and the average transmission delay of internal transmission of the first service flow in the first network node in the first in-situ flow detection period. The maximum transmission delay of internal transmission of the first service flow in the first network node in the first in-situ flow detection period refers to a maximum value of transmission delays of the plurality of packets in the first network node; the minimum transmission delay of internal transmission of the first service flow in the first network node in the first in-situ flow detection period refers to a minimum value of the transmission delays of the plurality of packets in the first network node; and the average transmission delay of internal transmission of the first service flow in the first network node in the first in-situ flow detection period refers to an average value of the transmission delays of the plurality of packets in the first network node.</p><p id="p-0020" num="0019">In a possible implementation, if the first network node is a transit node or a tail node in the detection domain, the first network node receives each of the plurality of packets through the first inbound interface. During implementation, for example, the first network node may receive, through the first inbound interface, each packet sent by a third network node. The third network node is an upstream node of the first network node, the third network node is connected to the first inbound interface through a second outbound interface, each received packet carries a third timestamp, and the third timestamp in each packet is a moment at which the third network node receives each packet through the second outbound interface. Correspondingly, when encapsulating the first timestamp of each packet into the in-situ flow detection information of each packet, the first network node may update the third timestamp in each packet to the first timestamp of each packet.</p><p id="p-0021" num="0020">In a possible implementation, the first network node may determine, based on the third timestamp carried in each packet and the first timestamp of each packet, a link transmission delay of each packet between the third network node and the first network node. Further, the first network node determines, based on the link transmission delay of each packet between the third network node and the first network node, a link transmission delay of the first service flow between the third network node and the first network node in the first in-situ flow detection period. Because the link transmission delay of the first service flow between the third network node and the first network node in the first in-situ flow detection period is determined with reference to the plurality of packets, accuracy is relatively high.</p><p id="p-0022" num="0021">In a possible implementation, after determining the link transmission delay of the first service flow between the third network node and the first network node in the first in-situ flow detection period, the first network node may send the determined link transmission delay to a controller, so that the controller analyzes the link transmission delay to determine performance of the detection domain.</p><p id="p-0023" num="0022">In a possible implementation, the link transmission delay of the first service flow between the third network node and the first network node in the first in-situ flow detection period includes any one or more of a maximum link transmission delay of the first service flow between the third network node and the first network node in the first in-situ flow detection period, a minimum link transmission delay of the first service flow between the third network node and the first network node in the first in-situ flow detection period, and an average link transmission delay of the first service flow between the third network node and the first network node in the first in-situ flow detection period.</p><p id="p-0024" num="0023">According to a second aspect, an embodiment may provide an in-situ flow detection method. The method may be performed by a first network node, and the first network node is a transit node or a tail node in a detection domain. The method may be used to determine an end-to-end transmission delay of a first service flow from a head node to the first network node in a first in-situ flow detection period. A first network node in a detection domain may perform the following operations on each of a plurality of packets in a first service flow that are received in a first in-situ flow detection period: The first network node receives each of the plurality of packets, where in-situ flow detection information of each of the plurality of packets carries a first timestamp, and the first timestamp of each packet indicates a moment at which a head node in the detection domain receives each packet; the first network node determines a second timestamp of each of the plurality of packets, where the second timestamp of each packet indicates a moment at which each packet is received through an outbound interface of the first network node; and the first network node determines, based on the first timestamp carried in each packet and the second timestamp of each packet, an end-to-end transmission delay of the first service flow from the head node to the first network node in the first in-situ flow detection period. In this embodiment, when determining an end-to-end transmission delay of a first service flow from a head node to the first network node in a first in-situ flow detection period, the head node colors a plurality of packets, instead of one packet, in the first in-situ flow detection period. When only one packet is colored, if packet loss occurs on the colored packet, the transmission delay in the detection domain in the first in-situ flow detection period cannot be determined. However, in the manner of coloring a plurality of packets, even if packet loss occurs on one or more of the packets, the end-to-end transmission delay in the detection domain may be determined based on another packet on which no packet loss occurs. In addition, determining the end-to-end transmission delay based on a plurality of packets has higher precision than determining the end-to-end transmission delay based on one packet. In conclusion, using the solution provided in this embodiment may improve precision of the detected end-to-end transmission delay of the first service flow from the head node to the first network node in the first in-situ flow detection period.</p><p id="p-0025" num="0024">In a possible implementation, the in-situ flow detection is iFIT in-situ flow detection.</p><p id="p-0026" num="0025">In a possible implementation, the in-situ flow detection information includes indication information, and the indication information indicates that the in-situ flow detection is end-to-end per-packet in-situ flow detection.</p><p id="p-0027" num="0026">In a possible implementation, the plurality of packets includes a first packet, the first packet includes first iFIT in-situ flow detection information, the first timestamp is located in a first flow instruction extension header FIEH in the first iFIT in-situ flow detection information, the iFIT in-situ flow detection information further includes indication information, and the indication information indicates that the in-situ flow detection is end-to-end per-packet in-situ flow detection.</p><p id="p-0028" num="0027">In a possible implementation, the first network node determines, based on the first timestamp carried in each packet and the second timestamp of each packet, the end-to-end transmission delay of the first service flow from the head node to the first network node in the first in-situ flow detection period. During implementation, for example, the first network node may determine, based on the first timestamp carried in each packet and the second timestamp of each packet, an end-to-end transmission delay of each packet from the head node to the first network node, and then determine, based on the end-to-end transmission delay of each packet from the head node to the first network node, the end-to-end transmission delay of the first service flow from the head node to the first network node in the first in-situ flow detection period.</p><p id="p-0029" num="0028">In a possible implementation, after determining the end-to-end transmission delay of the first service flow from the head node to the first network node in the first in-situ flow detection period, the first network node may send the determined end-to-end transmission delay to the controller, so that the controller analyzes the received transmission delay to determine performance of the detection domain.</p><p id="p-0030" num="0029">In a possible implementation, it is considered that a maximum end-to-end transmission delay of the first service flow from the head node to the first network node in the first in-situ flow detection period, a minimum end-to-end transmission delay of the first service flow from the head node to the first network node in the first in-situ flow detection period, and an average end-to-end transmission delay of the first service flow from the head node to the first network node in the first in-situ flow detection period can all reflect the end-to-end transmission delay of the first service flow from the head node to the first network node in the first in-situ flow detection period. Therefore, the end-to-end transmission delay of the first service flow from the head node to the first network node in the first in-situ flow detection period may include any one or more of the maximum end-to-end transmission delay of the first service flow from the head node to the first network node in the first in-situ flow detection period, the minimum end-to-end transmission delay of the first service flow from the head node to the first network node in the first in-situ flow detection period, and the average end-to-end transmission delay of the first service flow from the head node to the first network node in the first in-situ flow detection period.</p><p id="p-0031" num="0030">According to a third aspect, an embodiment may provide an in-situ flow detection method. The method may be performed by a controller. The controller may receive and store a transmission delay that is of a first service flow in a detection domain in a first in-situ flow detection period and that is sent by a first network node, where the transmission delay of the first service flow in the detection domain includes any one or more of a maximum transmission delay, a minimum transmission delay, and an average transmission delay. The transmission delay may be calculated by using the method in the first aspect or the second aspect. For the first in-situ flow detection period, compared with calculating the transmission delay of the first service flow in the detection domain based on one packet, the transmission delay received by the controller is obtained through calculation based on a plurality of packets. Therefore, the transmission delay is more accurate. Correspondingly, when determining performance of the detection domain based on the received transmission delay, the controller can obtain a more accurate result. In addition, the controller directly receives the transmission delay from the first network node, instead of respectively receiving a corresponding timestamp from the first network node and the head node. For example, for the first packet, the controller does not need to receive, from the head node, a timestamp at which a first packet is received through an inbound interface of the head node, and does not need to receive, from the first network node, a timestamp at which the first packet is received through an outbound interface of the first network node. Therefore, the controller does not need to store a received timestamp, and the controller does not need to calculate a transmission delay based on the timestamp, so that less data is stored and processed by the controller.</p><p id="p-0032" num="0031">In a possible implementation, the transmission delay of the first service flow in the detection domain includes an end-to-end transmission delay from a head node in the detection domain to the first network node.</p><p id="p-0033" num="0032">In a possible implementation, the transmission delay of the first service flow in the detection domain includes a transmission delay of the first service flow in the first network node, where the first network node is a head node or a transit node in the detection domain.</p><p id="p-0034" num="0033">In a possible implementation, the transmission delay of the first service flow in the detection domain includes a transmission delay of the first service flow between the first network node and a second network node, where the first network node is a transit node or a tail node in the detection domain, and the second network node is an upstream node of the first network node. In some embodiments, if there are several network nodes that do not support in-situ flow detection between the first network node and the second network node, the transmission delay of the first service flow between the first network node and the second network node includes a link delay of the first service flow between the first network node and the second network node, and transmission delays of the first service flow in the foregoing several network nodes that do not support in-situ flow detection.</p><p id="p-0035" num="0034">In a possible implementation, the transmission delay of the first service flow in the detection domain includes a link transmission delay of the first service flow between the first network node and the second network node, where the second network node is an upstream node adjacent to the first network node.</p><p id="p-0036" num="0035">According to a fourth aspect, an embodiment may further provide a first network node including a transceiver unit and a processing unit. The transceiver unit is configured to perform a receiving and sending operation in the method provided in the first aspect. The processing unit is configured to perform an operation other than the receiving and sending operation in the first aspect. For example, when the first network node is configured to perform the method according to any one of the first aspect or the possible implementations of the first aspect, the transceiver unit is configured to receive each of a plurality of packets through a first inbound interface, and the processing unit is configured to: encapsulate, into in-situ flow detection information of each received packet, a first timestamp at which each packet is received through the first inbound interface, and forward each packet encapsulated with the first timestamp to a first outbound interface. Alternatively, the transceiver unit is configured to perform a receiving and sending operation in the method provided in the second aspect. The processing unit is configured to perform an operation other than the receiving and sending operation in the second aspect. For example, when the first network node is configured to perform the method according to any one of the second aspect or the possible implementations of the second aspect, the transceiver unit is configured to receive each of the plurality of packets, where each of the plurality of packets carries a first timestamp, and the first timestamp of each packet indicates a moment at which a head node in the detection domain receives each packet; and the processing unit is configured to: determine a second timestamp of each of the plurality of packets, where the second timestamp of each packet indicates a moment at which each packet is received through an outbound interface of the first network node; and determine, based on the first timestamp carried in each packet and the second timestamp of each packet, an end-to-end transmission delay of the first service flow from the head node to the first network node in the first in-situ flow detection period.</p><p id="p-0037" num="0036">According to a fifth aspect, an embodiment may provide a controller including a transceiver unit and a processing unit. The transceiver unit is configured to perform a receiving and sending operation in the method provided in the third aspect. The processing unit is configured to perform an operation other than the receiving and sending operation in the third aspect. For example, the transceiver unit is configured to receive a transmission delay that is of a first service flow in a detection domain in a first in-situ flow detection period and that is sent by a first network node, and the processing unit is configured to store the received transmission delay.</p><p id="p-0038" num="0037">According to a sixth aspect, an embodiment may provide a first network node including a first inbound interface, a first outbound interface, and a processor connected to the first inbound interface and the first outbound interface. The first inbound interface is configured to perform an operation performed by the first inbound interface in the method according to any one of the implementations of the first aspect, and the first outbound interface is configured to perform an operation performed by the first outbound interface in the method according to any one of the implementations of the first aspect. The processor is configured to perform an operation other than the operations performed by the first inbound interface and the first outbound interface in the method according to the first aspect. Alternatively, the first inbound interface is configured to perform an operation of receiving a plurality of packets from an upstream network node in the method according to any one of the implementations of the second aspect, the first outbound interface is configured to perform an operation performed by an outbound interface of the first network node in the method according to any one of the implementations of the second aspect, and the processor is configured to perform an operation other than the operations performed by the first inbound interface and the first outbound interface in the method according to any one of the implementations of the second aspect.</p><p id="p-0039" num="0038">According to a seventh aspect, an embodiment may provide a controller including a communication interface and a processor connected to the communication interface. The communication interface is configured to perform receiving and sending operations in the method according to any one of the implementations of the third aspect, and the processor is configured to perform an operation other than the operation performed by the communication interface in the method according to any one of the implementations of the third aspect.</p><p id="p-0040" num="0039">According to an eighth aspect, an embodiment may provide a first network node. The first network node includes a memory and a processor. The memory is configured to store program code, and the processor is configured to run instructions in the program code, so that the first network node performs the method according to any one of the implementations of the first aspect or any one of the implementations of the second aspect.</p><p id="p-0041" num="0040">According to a ninth aspect, an embodiment may provide a controller. The controller includes a memory and a processor. The memory is configured to store program code, and the processor is configured to run instructions in the program code, so that the controller performs the method according to any one of the implementations of the third aspect.</p><p id="p-0042" num="0041">According to a tenth aspect, an embodiment may provide a non-transitory computer-readable storage medium including instructions or a computer program. When the non-transitory computer-readable storage medium runs on a computer, the computer is enabled to perform the method according to any one of the implementations of the first aspect, the method according to any one of the implementations of the second aspect, or the method according to any one of the implementations of the third aspect.</p><p id="p-0043" num="0042">According to an eleventh aspect, an embodiment may provide a computer program product including instructions or a computer program. When the computer program product runs on a computer, the computer is enabled to perform the method according to any one of the implementations of the first aspect, the method according to any one of the implementations of the second aspect, or the method according to any one of the implementations of the third aspect.</p><p id="p-0044" num="0043">According to a twelfth aspect, an embodiment may provide a communication system including a first network node and a controller. In an implementation, the first network node is the first network node according to any one of the implementations of the first aspect, or the first network node is the first network node according to any one of the implementations of the second aspect. In another implementation, the controller is the controller according to any one of the implementations of the third aspect.</p><?summary-of-invention description="Summary of Invention" end="tail"?><?brief-description-of-drawings description="Brief Description of Drawings" end="lead"?><description-of-drawings><heading id="h-0005" level="1">BRIEF DESCRIPTION OF THE DRAWINGS</heading><p id="p-0045" num="0044">To describe the embodiments more clearly, the following briefly describes the accompanying drawings. It is clear that the accompanying drawings in the following descriptions show only some embodiments and a person of ordinary skill in the art may still derive other drawings from these accompanying drawings without creative efforts.</p><p id="p-0046" num="0045"><figref idref="DRAWINGS">FIG. <b>1</b></figref> is a schematic diagram of a structure of an MPLS packet to which iFIT information is added;</p><p id="p-0047" num="0046"><figref idref="DRAWINGS">FIG. <b>2</b></figref> is a schematic diagram of a network architecture according to an embodiment;</p><p id="p-0048" num="0047"><figref idref="DRAWINGS">FIG. <b>3</b>A</figref> and <figref idref="DRAWINGS">FIG. <b>3</b>B</figref> are a signaling exchange diagram of an in-situ flow detection method according to an embodiment;</p><p id="p-0049" num="0048"><figref idref="DRAWINGS">FIG. <b>4</b></figref> is a schematic diagram of an FIEH field according to an embodiment;</p><p id="p-0050" num="0049"><figref idref="DRAWINGS">FIG. <b>5</b>A</figref> and <figref idref="DRAWINGS">FIG. <b>5</b>B</figref> are a signaling exchange diagram of an in-situ flow detection method according to an embodiment;</p><p id="p-0051" num="0050"><figref idref="DRAWINGS">FIG. <b>6</b></figref> is a schematic flowchart of an in-situ flow detection method according to an embodiment;</p><p id="p-0052" num="0051"><figref idref="DRAWINGS">FIG. <b>7</b></figref> is a schematic flowchart of an in-situ flow detection method according to an embodiment;</p><p id="p-0053" num="0052"><figref idref="DRAWINGS">FIG. <b>8</b></figref> is a schematic flowchart of an in-situ flow detection method according to an embodiment;</p><p id="p-0054" num="0053"><figref idref="DRAWINGS">FIG. <b>9</b></figref> is a schematic diagram of a structure of a first network node according to an embodiment;</p><p id="p-0055" num="0054"><figref idref="DRAWINGS">FIG. <b>10</b></figref> is a schematic diagram of a structure of a controller according to an embodiment;</p><p id="p-0056" num="0055"><figref idref="DRAWINGS">FIG. <b>11</b></figref> is a schematic diagram of a structure of a first network node according to an embodiment;</p><p id="p-0057" num="0056"><figref idref="DRAWINGS">FIG. <b>12</b></figref> is a schematic diagram of a structure of a controller according to an embodiment;</p><p id="p-0058" num="0057"><figref idref="DRAWINGS">FIG. <b>13</b></figref> is a schematic diagram of a structure of a first network node according to an embodiment; and</p><p id="p-0059" num="0058"><figref idref="DRAWINGS">FIG. <b>14</b></figref> is a schematic diagram of a structure of a controller according to an embodiment.</p></description-of-drawings><?brief-description-of-drawings description="Brief Description of Drawings" end="tail"?><?detailed-description description="Detailed Description" end="lead"?><heading id="h-0006" level="1">DETAILED DESCRIPTION OF THE EMBODIMENTS</heading><p id="p-0060" num="0059">The embodiments may provide an in-situ flow detection method and apparatus. According to the embodiments, precision of a detected transmission delay in a detection domain can be improved.</p><p id="p-0061" num="0060">To facilitate understanding, an iFIT technology is used as an example to briefly describe the in-situ flow detection technology.</p><p id="p-0062" num="0061">The iFIT technology may mark a service flow in a network based on iFIT information carried in packets. The marking is also referred to as coloring. The iFIT information may be used as a whole to form an iFIT header, for example, may be used as an extension header of a multi-protocol label switching (MPLS) protocol or the like. Alternatively, the iFIT information may be distributedly included in an internet protocol (IP) header based on field information or the like. A node through which the service flow passes reports collected data such as timestamps and quantities of packets to a control management device, so that the control management device further calculates a network delay, a packet loss status, a restoration path, and the like based on the reported data. In an MPLS network environment, a possible structure of an MPLS packet to which iFIT information is added is shown in <figref idref="DRAWINGS">FIG. <b>1</b></figref>. Herein, key fields shown in the MPLS packet are described.</p><p id="p-0063" num="0062">DA/SA/VLAN and 0x8847 form a layer 2 header (L2 header). DA indicates a destination address (DA), SA indicates a source address (SA), and VLAN indicates a virtual local area network (VLAN) identifier. MPLS Label indicates an MPLS label field, and the field is related to a service carried on an SR-TP tunnel. If the SR-TP tunnel carries a layer 3 virtual private network (L3VPN) service, the MPLS Label field may include a plurality of levels of label stacks and a path label. Details are not described herein. MPLS Payload indicates a payload field.</p><p id="p-0064" num="0063">A flow instruction indicator (FII) field, a flow instruction header (FIH) field, and a flow instruction extension header (FIEH) field shown in <figref idref="DRAWINGS">FIG. <b>1</b></figref> form the iFIT information. The following briefly describes the FII field, the FIH field, and the FIEH field.</p><p id="p-0065" num="0064">1. The FII field is used to identify that several bytes following the FII field are the iFIT information. For example, the FII field may include the following field information:</p><p id="p-0066" num="0065">a flow instruction indicator label (FII Label), where a default value may be configured to identify an iFIT detection flow;</p><p id="p-0067" num="0066">a priority EXP flag bit, where the priority EXP flag bit may be determined based on some related information in an outer MPLS label header;</p><p id="p-0068" num="0067">an S flag bit, used to mark whether it is a stack bottom, where, for example, a value of 1 indicates a stack bottom, and a value of 0 indicates a non-stack bottom; and</p><p id="p-0069" num="0068">a time to live (TTL) flag bit, where the TTL flag bit may also be determined based on some related information in the outer MPLS label header.</p><p id="p-0070" num="0069">2. The FIH field may also be referred to as an in-situ flow detection header or a flow detection header. This field is used to carry information related to iFIT detection. For example, the FIH field may include the following field information:</p><p id="p-0071" num="0070">a flow identifier (Flow ID), which is a globally unique identifier allocated to each piece of iFIT detection traffic;</p><p id="p-0072" num="0071">an L flag bit, namely, a packet loss detection color flag, where, for example, a value &#x201c;1&#x201d; of the L flag bit indicates that packet loss is collected, and a value &#x201c;0&#x201d; of the L flag bit indicates that packet loss is not collected;</p><p id="p-0073" num="0072">a D flag bit, namely, a delay measurement color flag, where, for example, a value &#x201c;1&#x201d; of the D flag bit indicates that a timestamp is collected, and a value &#x201c;0&#x201d; of the D flag bit indicates that the timestamp is not collected;</p><p id="p-0074" num="0073">a header type indicator (HTI), which marks a range of nodes that need to send an iFIT detection result and a detection content range, where, for example, different mark values may be used to distinguish whether to detect a path node capable of iFIT other than two end nodes, whether the FIEH field is valid, and the like; and an R flag bit, which may be used as a reserved flag bit.</p><p id="p-0075" num="0074">3. The FIEH field may also be referred to as a flow extension detection header or an extension in-situ flow detection header. As an extension field, this field is used to carry other information related to iFIT detection. For example, the FIEH field may include the following field information:</p><p id="p-0076" num="0075">a flow identifier extension Flow ID Ext, used to extend a bit width of a flow identifier;</p><p id="p-0077" num="0076">a V flag bit, used to mark a reverse flow, where for example, a value &#x201c;0&#x201d; of the V flag bit indicates that a current flow is a forward flow, and a receive end may automatically create a reverse flow; and a value &#x201c;1&#x201d; of the V flag bit indicates that a current flow is a reverse flow, and the receive end no longer automatically creates a reverse flow, where the V flag bit is an optional field, which is not shown in <figref idref="DRAWINGS">FIG. <b>1</b></figref>; and</p><p id="p-0078" num="0077">a period, where different values indicate different detection periods, and for example, the detection period may be 1 s, 10 s, 30 s, 1 min, or 10 min.</p><p id="p-0079" num="0078">It should be noted that, the foregoing only briefly describes a principle of an in-situ flow detection technology by using the iFIT technology as an example. The in-situ flow detection technology is not limited to the iFIT technology mentioned above. Other in-situ flow detection technologies are not described in detail herein.</p><p id="p-0080" num="0079">Generally, after receiving a packet sent by another device, a head node in a detection domain encapsulates in-situ flow detection information (for example, iFIT information) into the packet, to indicate a network node in the detection domain for in-situ flow detection. A type of the packet is generally a service packet. In an actual application scenario, a plurality of service packets may be sent consecutively. For example, the plurality of service packets may form a service flow, or the plurality of service packets are sent at intervals in a period. This is not limited herein.</p><p id="p-0081" num="0080">In a network, a network range for in-situ flow detection may be determined based on a specified detection domain Generally, a network node in the detection domain needs to transmit in-situ flow detection information for in-situ flow detection, and sends, to a control management device, corresponding information obtained through in-situ flow detection. A detection range of the detection domain may be determined in a plurality of manners, for example, based on network scenarios or service types. For example, a core network part in a network is specified as the detection domain, or detection domains of different ranges are specified based on video services and voice services. A detection domain includes three types of nodes: a head node, a tail node, and a hop-by-hop path node. The hop-by-hop path node may also be referred to as a transit node. The head node, tail node, and path node may be, for example, corresponding network nodes in a network. For a service flow, the 1<sup>st </sup>network node that transmits the service flow within a specified detection range in the detection domain may be used as a head node that transmits the service flow. The last network node that transmits the service flow within the specified detection range in the detection domain may be used as a tail node that transmits the service flow. Each node that transmits the service flow between the head node and the tail node is a hop-by-hop path node. The in-situ flow detection information may be added by the head node and stripped at the tail node.</p><p id="p-0082" num="0081">The detection domain may be a network domain in which in-situ flow detection is applied. The detection domain may include a plurality of forwarding devices capable of in-situ flow detection, for example, routers or switches. The detection domain may further include a control management device, for example, a logically centralized controller, configured to: configure in-situ flow detection for the plurality of forwarding devices in the detection domain, and collect and analyze in-situ flow detection data reported by the plurality of forwarding devices.</p><p id="p-0083" num="0082">It should be noted that <figref idref="DRAWINGS">FIG. <b>1</b></figref> is merely an example for description, and the in-situ flow detection technology may be applied to various other network environments. For example, in an Internet Protocol version 4 (IPv4) network environment, the in-situ flow detection information may be encapsulated in a field of an IPv4 packet. For another example, in an Internet Protocol version 6 (IPv6) network environment, the in-situ flow detection information may be encapsulated in a field of an IPv6 packet. For another example, in a segment routing IPv6 (SRv6) network environment, the iFIT information may be encapsulated in a field of an SRv6 packet.</p><p id="p-0084" num="0083"><figref idref="DRAWINGS">FIG. <b>2</b></figref> is a schematic diagram of a network architecture according to an embodiment. A network <b>100</b> includes a control management device and a plurality of network nodes. The plurality of network nodes is connected to each other through communication links, for transmission of service flows. As shown in <figref idref="DRAWINGS">FIG. <b>2</b></figref>, a head node, a transit node <b>1</b>, a transit node <b>2</b>, and a tail node in the detection domain are connected through communication links. In addition to the nodes shown in the figure, the detection domain may further include other nodes that are not shown. The tail node may be further connected to an external node through a communication link. The head node may receive a service flow from another device, and the service flow may reach the external node through the head node, the transit node <b>1</b>, the transit node <b>2</b>, and the tail node. The control management device may be, for example, a centralized controller, a network management system, or a traffic analysis device for traffic analysis. The control management device may be one device or may be a set of a plurality of devices.</p><p id="p-0085" num="0084">The detection domain may be determined by the control management device, and the detection domain is a detection range determined by the control management device; or the detection domain may be separately configured on each forwarding device in the detection domain, to form a detection domain. On a transmission path in the detection domain, network nodes located between the head node and the tail node in the detection domain are transit nodes, for example, the transit node <b>1</b> and the transit node <b>2</b> in <figref idref="DRAWINGS">FIG. <b>2</b></figref>.</p><p id="p-0086" num="0085">Currently, the control management device may deploy the in-situ flow detection technology on each node in the detection domain, to detect a transmission delay in the detection domain. The transmission delay in the detection domain may include an end-to-end transmission delay between the head node and the tail node. Each node in the detection domain may periodically perform a delay detection operation. With reference to <figref idref="DRAWINGS">FIG. <b>2</b></figref>, the following describes a conventional implementation of detecting the end-to-end transmission delay between the head node and the tail node. In an in-situ flow detection period, the head node may randomly select a packet from received packets for coloring. The head node may add in-situ flow detection information indicating detection of a transmission delay to the packet, and report, to the control management device, a timestamp indicating a moment at which the head node receives the packet. After receiving the packet, the tail node in the detection domain may forward the packet to an external node, and reports, to the control management device, a timestamp indicating a moment at which the tail node forwards the packet to the external node. The control management device may calculate the end-to-end transmission delay in the detection domain in the in-situ flow detection period based on the timestamp reported by the head node and the timestamp reported by the tail node. The control management device may determine a difference between the timestamp reported by the tail node and the timestamp reported by the head node as the end-to-end transmission delay in the detection domain in the in-situ flow detection period.</p><p id="p-0087" num="0086">Because packet loss may occur when the colored packet is transmitted in the detection domain, if packet loss occurs, the control management device cannot receive the timestamp sent by the tail node, the control management device cannot determine the end-to-end transmission delay in the detection domain in the in-situ flow detection period. In addition, an end-to-end transmission delay of a single packet in the detection domain cannot well represent the end-to-end transmission delay in the detection domain Therefore, an end-to-end transmission delay obtained in the foregoing manner of detecting the end-to-end transmission delay in the detection domain is inaccurate.</p><p id="p-0088" num="0087">To resolve the foregoing problem, an embodiment may provide an in-situ flow detection method. With reference to the accompanying drawings, the following describes delay detection performed by using the in-situ flow detection method.</p><p id="p-0089" num="0088">In the following descriptions of this embodiment, for ease of understanding, the iFIT in-situ flow detection is used as an example for description, but this does not constitute any limitation on this embodiment. The in-situ flow detection may include but is not limited to the iFIT in-situ flow detection.</p><p id="p-0090" num="0089"><figref idref="DRAWINGS">FIG. <b>3</b>A</figref> and <figref idref="DRAWINGS">FIG. <b>3</b>B</figref> are a signaling exchange diagram of the in-situ flow detection method according to an embodiment. The method shown in <figref idref="DRAWINGS">FIG. <b>3</b>A</figref> and <figref idref="DRAWINGS">FIG. <b>3</b>B</figref> may be used to detect an end-to-end transmission delay of a first service flow in a detection domain in a first in-situ flow detection period. The method <b>100</b> shown in <figref idref="DRAWINGS">FIG. <b>3</b>A</figref> and <figref idref="DRAWINGS">FIG. <b>3</b>B</figref> may be implemented by using the following S<b>101</b> to S<b>109</b>.</p><p id="p-0091" num="0090">S<b>101</b>: A head node receives a plurality of packets in the first service flow in the first in-situ flow detection period through an interface <b>1</b>.</p><p id="p-0092" num="0091">In this embodiment, the interface <b>1</b> is an interface through which the head node interacts with another device, and the interface <b>1</b> may be a physical interface on the head node. Generally, for a detection domain to which an iFIT technology is applied for delay detection, each node may periodically perform a delay detection operation. The first in-situ flow detection period is one of a plurality of periods for the delay detection operation. For the first in-situ flow detection period, an example is used herein for description. It is assumed that an in-situ flow detection period is T, and a moment at which the iFIT technology is deployed in the detection domain is to. In this case, a time period corresponding to the 1<sup>st </sup>in-situ flow detection period is (to, t<sub>0</sub>+T), a time period corresponding to the 2<sup>nd </sup>in-situ flow detection period is (t<sub>0</sub>+T, t<sub>0</sub>+2*T), and by analogy, and a time period corresponding to the n<sup>th </sup>in-situ flow detection period is (t<sub>0</sub>+(n&#x2212;1)*T, t<sub>0</sub>+n*T). The first in-situ flow detection period mentioned in this embodiment may be an in-situ flow detection period corresponding to a time period (t<sub>0</sub>+(i&#x2212;1)*T, t<sub>0</sub>+i*T), where i is an integer greater than or equal to 1.</p><p id="p-0093" num="0092">In this embodiment, the transmission delay in the detection domain is detected by coloring the first service flow. For a non-service flow, for example, a control packet or another protocol packet is not used for detection of the transmission delay in the detection domain. The plurality of packets may be all packets in the first service flow or may be some packets in the first service flow. The plurality of packets may be packets consecutively received by the head node through the interface <b>1</b> or may be packets received at intervals. This is not limited herein.</p><p id="p-0094" num="0093">S<b>102</b>: The head node encapsulates, into in-situ flow detection information of each packet, a timestamp T<b>1</b> at which each packet is received through the interface <b>1</b>.</p><p id="p-0095" num="0094">For each of the plurality of packets, each time the head node receives a packet, the head node determines a timestamp T<b>1</b> of the packet, where the timestamp T<b>1</b> of the packet indicates a moment at which the head node receives the packet through the interface <b>1</b>, and the head node encapsulates the timestamp T<b>1</b> into in-situ flow detection information of the received packet. A packet <b>1</b> in the plurality of packets is used as an example. When receiving the packet <b>1</b> through the interface <b>1</b>, the head node obtains a local timestamp of the head node, to obtain a timestamp T<b>1</b> of the packet <b>1</b>. After obtaining the timestamp T<b>1</b> of the packet <b>1</b>, the head node encapsulates the timestamp T<b>1</b> of the packet <b>1</b> into in-situ flow detection information of the packet <b>1</b>.</p><p id="p-0096" num="0095">In this embodiment, a field of the in-situ flow detection information may be extended to carry a timestamp field. The following uses iFIT as an example for introduction. An FIEH field of an iFIT header may be extended by adding the timestamp field <b>1</b>, where the timestamp T<b>1</b> is carried in the added timestamp field <b>1</b>. The extended FIEH field may be understood with reference to <figref idref="DRAWINGS">FIG. <b>4</b></figref>. <figref idref="DRAWINGS">FIG. <b>4</b></figref> is a schematic diagram of the FIEH field according to an embodiment. The Timestamp field shown in <figref idref="DRAWINGS">FIG. <b>4</b></figref> is the extended timestamp field <b>1</b>.</p><p id="p-0097" num="0096">In this embodiment, a length of the added timestamp field <b>1</b> may be determined based on precision of the timestamp T<b>1</b>. For example, if the timestamp T<b>1</b> is at nanosecond precision, the timestamp field <b>1</b> may include, for example, 8 bytes. Additionally, the timestamp field <b>1</b> may be further divided into a plurality of subfields. In an example, the timestamp field <b>1</b> includes a first subfield and a second subfield. The first subfield and the second subfield jointly carry the timestamp T<b>1</b>. For example, when a moment indicated by the timestamp T<b>1</b> is 5 minutes 5 seconds 100 nanoseconds, the first subfield carries a second-level timestamp indicating that the time is 5 minutes 5 seconds, and the second subfield carries a nanosecond-level timestamp indicating 100 nanoseconds.</p><p id="p-0098" num="0097">In an implementation of this embodiment, the in-situ flow detection information of each packet further includes indication information <b>1</b>, and the indication information <b>1</b> indicates that in-situ flow detection is end-to-end per-packet in-situ flow detection. The iFIT is used as an example. The indication information <b>1</b> may be carried using an HTI field of the iFIT in-situ flow detection information. In this embodiment, a meaning of the HTI field is extended. The HTI field may include 8 bits, and a value of the HTI field may range from 0 to 255. In an implementation of this embodiment, for example, a meaning of a value being 5 of the HTI field may be defined. When the value of the HTI field is 5, it may indicate that the in-situ flow detection information includes indication information indicating that the in-situ flow detection is the end-to-end per-packet in-situ flow detection. &#x201c;End-to-end&#x201d; means that the tail node performs a step of detecting an end-to-end transmission delay from the head node to the tail node. &#x201c;Per-packet&#x201d; means that the head node colors a plurality of packets in the first service flow. Correspondingly, the end-to-end transmission delay from the head node to the tail node that is calculated by the tail node is obtained through calculation based on the plurality of colored packets.</p><p id="p-0099" num="0098">S<b>103</b>: The head node forwards each packet encapsulated with the timestamp T<b>1</b> to an interface <b>2</b> of the head node.</p><p id="p-0100" num="0099">In this embodiment, the head node may determine, based on a destination IP address in the packet and a local packet forwarding table, an outbound interface for forwarding the packet. The interface <b>2</b> mentioned herein is the outbound interface for forwarding each packet. The interface <b>2</b> may be a physical interface on the head node.</p><p id="p-0101" num="0100">S<b>104</b>: The head node sends, through the interface <b>2</b>, each packet encapsulated with the timestamp T<b>1</b> to a transit node <b>1</b>.</p><p id="p-0102" num="0101">S<b>105</b>: The transit node <b>1</b> forwards each received packet to the tail node.</p><p id="p-0103" num="0102">S<b>106</b>: The tail node receives each packet sent by the transit node <b>1</b>.</p><p id="p-0104" num="0103">After the tail node receives each packet that carries the timestamp T<b>1</b>, because each packet carries the indication information <b>1</b>, the tail node determines an end-to-end transmission delay of the first service flow from the head node to the tail node in the first in-situ flow detection period based on the plurality of packets that carry the timestamp T<b>1</b>. The tail node may determine the end-to-end transmission delay of the first service flow from the head node to the tail node in the first in-situ flow detection period by performing S<b>107</b>.</p><p id="p-0105" num="0104">S<b>107</b>: The tail node determines a timestamp T<b>2</b> corresponding to each received packet and determines an end-to-end transmission delay of the first service flow from the head node to the tail node in the first in-situ flow detection period based on the timestamp T<b>1</b> carried in each packet and the timestamp T<b>2</b> of each packet.</p><p id="p-0106" num="0105">Each time the tail node receives a packet that carries a timestamp T<b>1</b>, the tail node may determine a timestamp T<b>2</b> of the packet. The timestamp T<b>2</b> indicates a moment at which the packet is received through an outbound interface of the tail node. The packet <b>1</b> is used as an example. After receiving the packet <b>1</b>, the tail node may determine the timestamp T<b>2</b> at which the packet <b>1</b> is received through the outbound interface of the tail node. After determining the timestamp T<b>2</b> corresponding to each packet, the tail node may calculate the end-to-end transmission delay of the first service flow from the head node to the tail node in the first in-situ flow detection period based on the timestamp T<b>1</b> carried in each packet and the timestamp T<b>2</b> of each packet. The tail node may calculate an end-to-end transmission delay of each packet from the head node to the tail node based on the timestamp T<b>1</b> of each packet and the timestamp T<b>2</b> of each packet. The packet <b>1</b> is used as an example. The tail node may calculate a difference between the timestamp T<b>2</b> of the packet <b>1</b> and the timestamp T<b>1</b> of the packet <b>1</b>, to obtain the end-to-end transmission delay of the packet <b>1</b> from the head node to the tail node. After calculating the end-to-end transmission delay of each packet from the head node to the tail node, the tail node may determine the end-to-end transmission delay of the first service flow from the head node to the first network node in the first in-situ flow detection period based on the end-to-end transmission delay of each packet from the head node to the tail node.</p><p id="p-0107" num="0106">For the end-to-end transmission delay of the first service flow from the head node to the first network node in the first in-situ flow detection period, it should be noted that in this embodiment, a maximum value of the end-to-end transmission delays of the packets from the head node to the tail node, a minimum value of the end-to-end transmission delays of the packets from the head node to the tail node, and an average value of the end-to-end transmission delays of the packets from the head node to the tail node are considered, and may all reflect the end-to-end transmission delay of the first service flow from the head node to the first network node in the first in-situ flow detection period. Therefore, in this embodiment, the end-to-end transmission delay of the first service flow from the head node to the first network node in the first in-situ flow detection period may be any one or more of the maximum end-to-end transmission delay of the packets from the head node to the tail node, the minimum end-to-end transmission delay of the packets from the head node to the tail node, and the average end-to-end transmission delay of the packets from the head node to the tail node. In other words, after determining the end-to-end transmission delay of each packet from the head node to the tail node, the tail node may determine one or more of the maximum value of the end-to-end transmission delays of the packets from the head node to the tail node, the minimum value of the end-to-end transmission delays of the packets from the head node to the tail node, and the average value of the end-to-end transmission delays of the packets from the head node to the tail node as the end-to-end transmission delay of the first service flow from the head node to the first network node in the first in-situ flow detection period. The maximum value of the end-to-end transmission delays of the packets from the head node to the tail node may also be referred to as a maximum end-to-end transmission delay of the packets from the head node to the tail node. The minimum value of the end-to-end transmission delays of the packets from the head node to the tail node may also be referred to as a minimum end-to-end transmission delay of the packets from the head node to the tail node. The average value of the end-to-end transmission delays of the packets from the head node to the tail node may also be referred to as an average end-to-end transmission delay of the packets from the head node to the tail node.</p><p id="p-0108" num="0107">S<b>108</b>: The tail node reports the end-to-end transmission delay of the first service flow from the head node to the tail node in the first in-situ flow detection period to the control management device.</p><p id="p-0109" num="0108">After determining the end-to-end transmission delay of the first service flow from the head node to the tail node in the first in-situ flow detection period, the tail node may report the end-to-end transmission delay to the control management device, so that the control management device performs analysis and processing based on the received data. In an example, the tail node may encapsulate the end-to-end transmission delay of the first service flow from the head node to the tail node in the first in-situ flow detection period into a YANG model and report the end-to-end transmission delay to the control management device using a representational state transfer configuration protocol (RESTCONF). Alternatively, the tail node may report the end-to-end transmission delay of the first service flow from the head node to the tail node in the first in-situ flow detection period to the control management device using a telemetry technology.</p><p id="p-0110" num="0109">It should be noted that, in this embodiment, when sending data to the control management device, a node in the detection domain may encapsulate the to-be-sent data into a YANG model and report the data to the control management device using the RESTCONF, or report the to-be-sent data to the control management device using telemetry. Therefore, for reporting data by a node in the detection domain to the control management device, details are not described.</p><p id="p-0111" num="0110">In an embodiment, in addition to indicating the tail node to determine the end-to-end transmission delay of the first service flow from the head node to the tail node in the first in-situ flow detection period, the indication information <b>1</b> may further indicate the transit node <b>1</b> to determine an end-to-end transmission delay of the first service flow from the head node to the transit node <b>1</b> in the first in-situ flow detection period. In other words, the foregoing &#x201c;end-to-end&#x201d; may also mean that the transit node <b>1</b> performs a step of detecting the end-to-end transmission delay from the head node to the transit node <b>1</b>. In addition to S<b>105</b>, the transit node <b>1</b> may further perform S<b>1051</b> and S<b>1052</b>.</p><p id="p-0112" num="0111">S<b>1051</b>: The transit node <b>1</b> determines a timestamp T<b>3</b> corresponding to each received packet and determines the end-to-end transmission delay of the first service flow from the head node to the transit node <b>1</b> in the first in-situ flow detection period based on the timestamp T<b>1</b> carried in each packet and the timestamp T<b>3</b> of each packet.</p><p id="p-0113" num="0112">The timestamp T<b>3</b> of each packet indicates a moment at which each packet is received through an outbound interface of the transit node <b>1</b>.</p><p id="p-0114" num="0113">S<b>1052</b>: The transit node <b>1</b> reports the end-to-end transmission delay of the first service flow from the head node to the transit node <b>1</b> in the first in-situ flow detection period to the control management device.</p><p id="p-0115" num="0114">An implementation principle of S<b>1051</b> and S<b>1052</b> is similar to that of S<b>107</b> and S<b>108</b>. Therefore, for implementation of S<b>1051</b> and S<b>1052</b>, refer to the foregoing description part of S<b>107</b> and S<b>108</b>. Details are not described herein.</p><p id="p-0116" num="0115">It should be noted that, in the method shown in <figref idref="DRAWINGS">FIG. <b>3</b>A</figref> and <figref idref="DRAWINGS">FIG. <b>3</b>B</figref>, although only one transit node is shown, in an actual application, the first service flow may pass through several transit nodes supporting the iFIT technology for transmission of the first service flow in the detection domain. Operations performed by the transit nodes are similar. The transit node may receive a packet from an upstream device and forwards the packet to a downstream device. Steps of calculating the end-to-end transmission delay performed by the transit nodes are the same as steps performed by the transit node <b>1</b>. Details are not described herein.</p><p id="p-0117" num="0116">It can be understood from the foregoing descriptions that, in this embodiment, the head node detects the end-to-end transmission delay by coloring a plurality of packets of the first service flow. Even if one or more colored packets are lost, the end-to-end transmission delay in the detection domain in the first in-situ flow detection period can still be determined based on another packet that is not lost. In addition, the manner of determining the end-to-end transmission delay in the detection domain in the first in-situ flow detection period based on a plurality of packets has higher precision than a manner of determining the end-to-end transmission delay in the detection domain in the first in-situ flow detection period based on one packet. In conclusion, using the solution provided in this embodiment may improve the precision of the detected end-to-end transmission delay in the detection domain.</p><p id="p-0118" num="0117">In addition, to more accurately reflect transmission performance of a detection domain, an embodiment may further provide an in-situ flow detection method. The method may be used to detect a transmission delay of a first service flow between nodes in a detection domain and a transmission delay of the first service flow in a node in a first in-situ flow detection period. The following describes the in-situ flow detection method with reference to <figref idref="DRAWINGS">FIG. <b>5</b>A</figref> and <figref idref="DRAWINGS">FIG. <b>5</b>B</figref>. <figref idref="DRAWINGS">FIG. <b>5</b>A</figref> and <figref idref="DRAWINGS">FIG. <b>5</b>B</figref> are a signaling exchange diagram of the in-situ flow detection method according to an embodiment. For example, the method <b>200</b> shown in <figref idref="DRAWINGS">FIG. <b>5</b>A</figref> and <figref idref="DRAWINGS">FIG. <b>5</b>B</figref> may be implemented by performing S<b>201</b> to S<b>214</b>.</p><p id="p-0119" num="0118">S<b>201</b>: A head node receives a plurality of packets in the first service flow in the first in-situ flow detection period through an interface <b>1</b>.</p><p id="p-0120" num="0119">S<b>202</b>: The head node encapsulates, into in-situ flow detection information of each packet, a timestamp T<b>1</b> at which each packet is received through the interface <b>1</b>.</p><p id="p-0121" num="0120">S<b>203</b>: The head node forwards each packet encapsulated with the timestamp T<b>1</b> to an interface <b>2</b> of the head node.</p><p id="p-0122" num="0121">A basic principle of S<b>201</b> to S<b>203</b> is the same as that of S<b>101</b> to S<b>103</b>. Therefore, for implementation of S<b>201</b> to S<b>203</b>, refer to the foregoing description part of S<b>101</b> to S<b>103</b>. Details are not described herein again.</p><p id="p-0123" num="0122">It should be noted that a difference between S<b>201</b> to S<b>203</b> and S<b>101</b> to S<b>103</b> lies in that the in-situ flow detection information of each packet mentioned in S<b>201</b> to S<b>203</b> includes indication information <b>2</b>, and the indication information <b>2</b> indicates that the in-situ flow detection is hop-by-hop per-packet in-situ flow detection. Similar to the indication information <b>1</b>, the indication information <b>2</b> may also be carried by using an HTI field in the in-situ flow detection information, and a meaning of the HTI field may be extended. For example, a meaning of a value 6 of the HTI field may be defined. When the value of the HTI field is 6, it indicates that the in-situ flow detection information includes indication information indicating that the in-situ flow detection is hop-by-hop per-packet in-situ flow detection. &#x201c;Hop-by-hop&#x201d; means that each node that supports an iFIT technology and that receives the colored packet needs to perform detection of a link delay and a transmission delay in the node. The meaning of &#x201c;per-packet&#x201d; is mentioned above, and details are not described herein again.</p><p id="p-0124" num="0123">S<b>204</b>: The head node determines a timestamp T<b>4</b> of each packet and determines a transmission delay of the first service flow in the head node in the first in-situ flow detection period based on the timestamp T<b>1</b> carried in each packet and the timestamp T<b>4</b> of each packet.</p><p id="p-0125" num="0124">In this embodiment, the timestamp T<b>4</b> of each packet indicates a moment at which each packet is received through the interface <b>2</b> of the head node.</p><p id="p-0126" num="0125">It may be understood that, because the indication information <b>2</b> indicates that the in-situ flow detection is hop-by-hop per-packet in-situ flow detection, the head node needs to calculate the transmission delay of the first service flow in the head node. When receiving one of the plurality of packets, the head node may determine a timestamp T<b>4</b> corresponding to the packet, and determine a transmission delay of the first service flow in the head node in the first in-situ flow detection period based on the timestamp T<b>1</b> carried in each packet and the timestamp T<b>4</b> of each packet. The head node may calculate the transmission delay of the packet in the head node based on the timestamp T<b>1</b> carried in each packet and the timestamp T<b>4</b> of each packet. The packet <b>1</b> is used as an example. The head node may determine a difference between a timestamp T<b>4</b> and a timestamp T<b>1</b> of the packet <b>1</b> as a transmission delay of the packet <b>1</b> in the head node. Further, after calculating the transmission delay of each packet in the head node, the head node determines the transmission delay of the first service flow in the head node in the first in-situ flow detection period based on the transmission delay of each packet in the head node.</p><p id="p-0127" num="0126">A maximum value of the transmission delays of the packets in the head node, a minimum value of the transmission delays of packets in the head node, and an average value of the transmission delays of packets in the head node may all reflect the transmission delay of the first service flow in the head node in the first in-situ flow detection period. Therefore, in this embodiment, the head node may determine any one or more of the maximum value of the transmission delays of packets in the head node, the minimum value of the transmission delays of packets in the head node, and the average value of the transmission delays of packets in the head node as the transmission delay of the first service flow in the head node in the first in-situ flow detection period. The maximum value of the transmission delays of the packets in the head node may also be referred to as a maximum transmission delay of the packets in the head node; the minimum value of the transmission delays of the packets in the head node may also be referred to as a minimum transmission delay of the packets in the head node; and the average value of the transmission delays of packets in the head node may also be referred to as an average transmission delay of the packets in the head node.</p><p id="p-0128" num="0127">S<b>205</b>: The head node reports the transmission delay of internal transmission of the first service flow in the head node in the first in-situ flow detection period to the control management device.</p><p id="p-0129" num="0128">After determining the transmission delay of internal transmission of the first service flow in the head node in the first in-situ flow detection period, the head node may report the transmission delay of internal transmission of the first service flow in the head node in the first in-situ flow detection period to the control management device, so that the control management device performs analysis and processing based on the received data.</p><p id="p-0130" num="0129">S<b>206</b>: The head node replaces the timestamp T<b>1</b> of each packet with the timestamp T<b>4</b>.</p><p id="p-0131" num="0130">In this embodiment, to enable the transit node <b>1</b> receiving each packet to determine a transmission delay of the first service flow between the head node and the transit node <b>1</b> in the first in-situ flow detection period, the head node may replace the timestamp T<b>1</b> carried in each packet with a corresponding timestamp T<b>4</b>, that is, replace the timestamp T<b>1</b> in the packet <b>1</b> with the timestamp T<b>4</b> of the packet <b>1</b>, and replace a timestamp T<b>1</b> in a packet <b>2</b> with a timestamp T<b>4</b> of the packet <b>2</b>.</p><p id="p-0132" num="0131">S<b>207</b>: The head node forwards each packet encapsulated with the timestamp T<b>4</b> to the transit node <b>1</b> through the interface <b>2</b> of the head node.</p><p id="p-0133" num="0132">S<b>208</b>: The transit node <b>1</b> determines a timestamp T<b>5</b> corresponding to a moment at which each packet is received and determines a transmission delay of the first service flow from the head node to the transit node <b>1</b> in the first in-situ flow detection period based on the timestamp T<b>4</b> of each packet and the timestamp T<b>5</b> of each packet.</p><p id="p-0134" num="0133">After receiving each packet encapsulated with the timestamp T<b>4</b>, the transit node <b>1</b> may determine the transmission delay of the first service flow between the head node and the transit node <b>1</b> in the first in-situ flow detection period based on the timestamp T<b>4</b> carried in each of the plurality of packets. The transit node <b>1</b> may determine the timestamp T<b>5</b> corresponding to the time at which each packet is received. The timestamp T<b>5</b> indicates a moment at which the packet is received from the head node through the interface <b>1</b> of the transit node. Then, the transit node <b>1</b> calculates a transmission delay of each packet between the head node and the transit node <b>1</b> based on the timestamp T<b>4</b> of each packet and the timestamp T<b>5</b> of each packet. The packet <b>1</b> is used as an example. The transit node <b>1</b> may determine a difference between the timestamp T<b>5</b> and the timestamp T<b>4</b> of the packet <b>1</b> as a transmission delay of the packet <b>1</b> between the head node and the transit node <b>1</b>. Further, the transit node <b>1</b> may determine a transmission delay of the first service flow between the head node and the transit node <b>1</b> in the first in-situ flow detection period based on a transmission delay of each packet between the head node and the transit node <b>1</b>. The interface <b>1</b> of the transit node <b>1</b> mentioned above may be a physical interface on the transit node <b>1</b>.</p><p id="p-0135" num="0134">It is considered that a maximum value of the transmission delays of the packets between the head node and the transit node <b>1</b>, a minimum value of the transmission delays of the packets between the head node and the transit node <b>1</b>, and an average value of the transmission delays of the packets between the head node and the transit node <b>1</b> may all reflect, to some extent, the transmission delay of the first service flow between the head node and the transit node <b>1</b> in the first in-situ flow detection period. Therefore, the transit node <b>1</b> may determine any one or more of the maximum value of the transmission delays of packets between the head node and the transit node <b>1</b>, the minimum value of the transmission delays of packets between the head node and the transit node <b>1</b>, and the average value of the transmission delays of packets between the head node and the transit node <b>1</b> as the transmission delay of the first service flow between the head node and the transit node <b>1</b> in the first in-situ flow detection period.</p><p id="p-0136" num="0135">S<b>209</b>: The transit node <b>1</b> reports the transmission delay of the first service flow between the head node and the transit node <b>1</b> in the first in-situ flow detection period to the control management device.</p><p id="p-0137" num="0136">After determining the transmission delay of the first service flow between the head node and the transit node <b>1</b> in the first in-situ flow detection period, the transit node <b>1</b> may report the determined link transmission delay to the control management device, so that the control management device performs analysis and processing based on the received data.</p><p id="p-0138" num="0137">It should be noted that, in this embodiment, the head node may be an upstream node adjacent to the transit node <b>1</b>, in other words, the transit node <b>1</b> is a next-hop node of the head node. However, in an actual application, the head node may not be the upstream node adjacent to the transit node <b>1</b>. That is, when the head node forwards the plurality of packets to the transit node <b>1</b>, the plurality of packets passes through a plurality of other nodes that do not support the iFIT technology. It may be understood that, if the head node is the upstream node adjacent to the transit node, the transmission delay of the first service flow between the head node and the transit node <b>1</b> in the first in-situ flow detection period is a link transmission delay of the first service flow between the head node and the transit node <b>1</b> in the first in-situ flow detection period. In other words, if the head node is the upstream node adjacent to the transit node, delay performance of a direct link between the head node and the transit node <b>1</b> can be detected by using the solution in this embodiment.</p><p id="p-0139" num="0138">S<b>210</b>: The transit node <b>1</b> replaces the timestamp T<b>4</b> carried in each packet with the timestamp T<b>5</b> and forwards each packet that carries the timestamp T<b>5</b> to an interface <b>2</b> of the transit node <b>1</b>.</p><p id="p-0140" num="0139">In this embodiment, to enable the transit node <b>1</b> receiving each packet to determine a transmission delay of the first service flow in the transit node <b>1</b> in the first in-situ flow detection period, the transit node <b>1</b> may replace the timestamp T<b>4</b> carried in each packet with a corresponding timestamp T<b>5</b>, that is, replace the timestamp T<b>4</b> in the packet <b>1</b> with the timestamp T<b>5</b> of the packet <b>1</b>, and replace a timestamp T<b>4</b> in a packet <b>2</b> with a timestamp T<b>5</b> of the packet <b>2</b>.</p><p id="p-0141" num="0140">The interface <b>2</b> of the transit node <b>1</b> mentioned herein is an interface configured to forward each packet to a downstream device. The interface <b>2</b> may be a physical interface in the transit node <b>1</b>.</p><p id="p-0142" num="0141">S<b>211</b>: The transit node <b>1</b> determines a timestamp T<b>6</b> of each packet and determines a transmission delay of the first service flow in the transit node <b>1</b> in the first in-situ flow detection period based on the timestamp T<b>5</b> of each packet and the timestamp T<b>6</b> of each packet.</p><p id="p-0143" num="0142">In this embodiment, the timestamp T<b>6</b> of each packet indicates a moment at which each packet is received through the interface <b>2</b> of the transit node <b>1</b>.</p><p id="p-0144" num="0143">It should be noted that a principle of S<b>211</b> is the same as a principle of S<b>204</b> in which the head node determines the transmission delay of the first service flow in the head node in the first in-situ flow detection period. After obtaining a plurality of packets that carry the timestamp T<b>5</b>, the interface <b>2</b> of the transit node <b>1</b> may determine the timestamp T<b>6</b> of each packet, and determine the transmission delay of the first service flow in the transit node <b>1</b> in the first in-situ flow detection period based on the timestamp T<b>5</b> of each packet and the timestamp T<b>6</b> of each packet.</p><p id="p-0145" num="0144">First, the transit node <b>1</b> may determine the transmission delay of each packet in the transit node <b>1</b> based on the timestamp T<b>5</b> of each packet and the timestamp T<b>6</b> of each packet. The packet <b>1</b> is used as an example. The transit node <b>1</b> may determine a difference between a timestamp T<b>6</b> of the packet <b>1</b> and a timestamp T<b>5</b> of the packet <b>1</b> as a transmission delay of the packet <b>1</b> in the transit node <b>1</b>. Then, the transit node <b>1</b> determines a transmission delay of the first service flow in the transit node <b>1</b> in the first in-situ flow detection period based on the transmission delay of each packet in the transit node <b>1</b>. Similar to determining, by the head node, the transmission delay of the first service flow in the head node in the first in-situ flow detection period, the transit node <b>1</b> may determine any one or more of a maximum transmission delay of the packets in the transit node <b>1</b>, a minimum transmission delay of the packets in the transit node <b>1</b>, and an average transmission delay of the packets in the transit node <b>1</b> as the transmission delay of the first service flow in the transit node <b>1</b> in the first in-situ flow detection period. The maximum transmission delay of the packets in the transit node <b>1</b> is a maximum value of the transmission delays of the packets in the transit node <b>1</b>. The minimum transmission delay of packets in the transit node <b>1</b> is a minimum value of the transmission delays of the packets in the transit node <b>1</b>. The average transmission delay of the packets in the transit node <b>1</b> is an average value of the transmission delays of the packets in the transit node <b>1</b>.</p><p id="p-0146" num="0145">S<b>212</b>: The transit node <b>1</b> reports the transmission delay of the first service flow in the transit node <b>1</b> in the first in-situ flow detection period to the control management device.</p><p id="p-0147" num="0146">After determining the transmission delay of the first service flow in the transit node <b>1</b> in the first in-situ flow detection period, the transit node <b>1</b> may report the transmission delay to the control management device, so that the control management device performs analysis and processing based on the received data.</p><p id="p-0148" num="0147">S<b>213</b>: The transit node <b>1</b> replaces the timestamp T<b>5</b> carried in each packet with the timestamp T<b>6</b> of each packet.</p><p id="p-0149" num="0148">S<b>214</b>: The transit node <b>1</b> forwards each packet that carries the timestamp T<b>6</b> to the tail node through the interface <b>2</b> of the transit node <b>1</b>.</p><p id="p-0150" num="0149">For S<b>213</b> and S<b>214</b>, it should be noted that, to enable the tail node to calculate a transmission delay of the first service flow between the transit node <b>1</b> and the tail node in the first in-situ flow detection period, the transit node may replace the timestamp T<b>5</b> carried in each packet with the timestamp T<b>6</b> of each packet, and forward each packet that carries the timestamp T<b>6</b> to the tail node through the interface <b>2</b> of the transit node <b>1</b>.</p><p id="p-0151" num="0150">After the transit node <b>1</b> sends each packet that carries the timestamp T<b>6</b> to the tail node, the tail node may also calculate the transmission delay of the first service flow between the transit node <b>1</b> and the tail node in the first in-situ flow detection period based on the plurality of packets that carry the timestamp T<b>6</b>, and report the transmission delay to the control management device. Correspondingly, the tail node may further calculate a transmission delay of the first service flow in the tail node in the first in-situ flow detection period and report the transmission delay of the first service flow in the tail node in the first in-situ flow detection period to the control management device. A calculation manner in which the tail node calculates the transmission delay of the first service flow between the transit node <b>1</b> and the tail node in the first in-situ flow detection period is similar to a implementation in which the transit node <b>1</b> calculates the transmission delay of the first service flow between the head node and the transit node <b>1</b> in the first in-situ flow detection period, and details are not described herein again. Correspondingly, a calculation manner in which the tail node calculates the transmission delay of the first service flow in the tail node in the first in-situ flow detection period is similar to a implementation in which the transit node <b>1</b> calculates the transmission delay of the first service flow in the transit node <b>1</b> in the first in-situ flow detection period, and details are not described herein again.</p><p id="p-0152" num="0151">It should be noted that, in this embodiment, the transit node <b>1</b> may be an upstream node adjacent to the tail node, in other words, the tail node is a next-hop node of the transit node <b>1</b>. However, in an actual application, the transit node <b>1</b> may not be the upstream node adjacent to the tail node. That is, when the transit node <b>1</b> forwards the plurality of packets to the tail node, the plurality of packets pass through a plurality of other nodes that do not support the iFIT technology. It may be understood that, if the transit node <b>1</b> is the upstream node adjacent to the tail node, the transmission delay of the first service flow between the transit node <b>1</b> and the tail node in the first in-situ flow detection period is a link transmission delay of the first service flow between the transit node <b>1</b> and the tail node in the first in-situ flow detection period. In other words, if the transit node <b>1</b> is the upstream node adjacent to the tail node, delay performance of a direct link between the transit node <b>1</b> and the tail node can be detected by using the solution in this embodiment.</p><p id="p-0153" num="0152">In this embodiment, a node that supports iFIT detection in the detection domain may be further configured to perform end-to-end per-packet in-situ detection and hop-by-hop per-packet in-situ flow detection. In this case, in this embodiment, a value of the HTI field may be redefined. For example, a value from values that are not defined in the current HTI field is redefined. For example, a meaning that the HTI field is equal to 10 is redefined. When the value of the HTI field is 10, it indicates that the flow detection information includes indication information indicating that the in-situ flow detection is end-to-end per-packet in-situ flow detection and hop-by-hop per-packet in-situ flow detection. Correspondingly, the FIEH field may be further extended to obtain two timestamp fields: a first timestamp field and a second timestamp field. The packet <b>1</b> is used as an example. The first timestamp field carries a timestamp at which the head node obtains the packet <b>1</b>. When the packet <b>1</b> is transmitted in the detection domain, a value of the first timestamp field remains unchanged, and is a timestamp T<b>1</b> corresponding to the packet <b>1</b>. The second timestamp field carries times at which the packet <b>1</b> is received through an outbound interface of the head node (that is, the interface <b>2</b> of the head node mentioned above), an interface of each transit node, and an inbound interface of the tail node when the packet is transmitted in the detection domain. A value of the second timestamp field is updated in real time as the packet <b>1</b> is transmitted. For example, the value of the second timestamp field is updated from the timestamp T<b>4</b> to the timestamp T<b>5</b>, and then is updated from the timestamp T<b>5</b> to the timestamp T<b>6</b>.</p><p id="p-0154" num="0153">For the first timestamp field and the second timestamp field, refer to the descriptions of the timestamp field <b>1</b> in S<b>102</b>. Details are not described herein again.</p><p id="p-0155" num="0154">An embodiment further provides an in-situ flow detection method <b>300</b>. <figref idref="DRAWINGS">FIG. <b>6</b></figref> is a schematic flowchart of the in-situ flow detection method according to an embodiment. The method shown in <figref idref="DRAWINGS">FIG. <b>6</b></figref> may be performed, for example, by a first network node in a detection domain. The first network node may perform the following S<b>301</b> to S<b>303</b> for each of a plurality of packets in a first service flow received in a first in-situ flow detection period.</p><p id="p-0156" num="0155">S<b>301</b>: The first network node receives each of the plurality of packets through a first inbound interface.</p><p id="p-0157" num="0156">S<b>302</b>: The first network node encapsulates, into in-situ flow detection information of each received packet, a first timestamp at which each packet is received through the first inbound interface, where the first timestamp of each packet indicates a moment at which the first network node receives each packet through the first inbound interface.</p><p id="p-0158" num="0157">S<b>303</b>: The first network node forwards, to a first outbound interface, each packet encapsulated with the first timestamp.</p><p id="p-0159" num="0158">The method <b>300</b> may be applied to the method <b>100</b> provided in the foregoing embodiment and is configured to perform the steps performed by the head node in the method <b>100</b>. The method <b>300</b> may also be applied to the method <b>200</b> provided in the foregoing embodiment and is configured to perform some steps performed by the head node, the transit node <b>1</b>, and the tail node in the method <b>200</b>.</p><p id="p-0160" num="0159">When the method <b>300</b> is applied to the method <b>100</b> provided in the foregoing embodiment, the first network node may correspond to the head node in the method <b>100</b>. The first inbound interface may correspond to the interface <b>1</b> of the head node in the method <b>100</b>. The first timestamp of each packet may correspond to the timestamp T<b>1</b> of each packet in the method <b>100</b>. The first outbound interface may correspond to the interface <b>2</b> of the head node in the method <b>100</b>.</p><p id="p-0161" num="0160">When the method <b>300</b> is applied to the method <b>200</b> provided in the foregoing embodiment, the first network node may correspond to the head node, the transit node <b>1</b>, or the tail node in the method <b>200</b>. When the first network node corresponds to the head node in the method <b>200</b>, the first inbound interface may correspond to the interface <b>1</b> of the head node, and the first timestamp of each packet may correspond to the timestamp T<b>1</b> of each packet in the method <b>200</b>. The first outbound interface may correspond to the interface <b>2</b> of the head node in the method <b>200</b>. When the first network node corresponds to the transit node <b>1</b> in the method <b>200</b>, the first inbound interface may correspond to the interface <b>1</b> of the transit node <b>1</b>, and the first timestamp of each packet may correspond to the timestamp T<b>5</b> of each packet in the method <b>200</b>. The first outbound interface may correspond to the interface <b>2</b> of the transit node <b>1</b> in the method <b>200</b>. When the first network node corresponds to the tail node in the method <b>200</b>, the first inbound interface may be, for example, an interface through which the tail node receives each packet from an upstream node such as the transit node <b>1</b>, and the first timestamp of each packet may be, for example, a timestamp at which the tail node receives each packet from the upstream node such as the transit node <b>1</b>. For example, the first outbound interface may be an interface that forwards each packet to an external node outside the detection domain.</p><p id="p-0162" num="0161">In an implementation, the in-situ flow detection information further includes indication information, and the indication information indicates that the in-situ flow detection is end-to-end per-packet in-situ flow detection and/or hop-by-hop per-packet in-situ flow detection.</p><p id="p-0163" num="0162">In an implementation, the in-situ flow detection information is iFIT in-situ flow detection information.</p><p id="p-0164" num="0163">In an implementation, the plurality of packets includes a first packet, and that the first network node encapsulates the first timestamp of each packet into the in-situ flow detection information of each packet includes: The first network node encapsulates, into a first flow instruction extension header FIEH of an iFIT in-situ flow detection information of the first packet, the first timestamp at which the first packet is received through the first inbound interface.</p><p id="p-0165" num="0164">In an implementation, the first iFIT in-situ flow detection information further includes indication information, and the indication information indicates that the in-situ flow detection is end-to-end per-packet in-situ flow detection and/or hop-by-hop per-packet in-situ flow detection.</p><p id="p-0166" num="0165">In an implementation, when the indication information indicates that the in-situ flow detection is hop-by-hop per-packet in-situ flow detection, the method <b>300</b> further includes: The first network node receives, through the first outbound interface, each packet that is encapsulated with the first timestamp and that is from the first inbound interface; the first network node updates each first timestamp of the plurality of packets to a second timestamp of each packet, where the second timestamp of each packet indicates a moment at which each packet is received through the first outbound interface; and the first network node sends each packet encapsulated with the second timestamp to a second network node through the first outbound interface.</p><p id="p-0167" num="0166">In this case, the method <b>300</b> may be applied to the method <b>200</b> provided in the foregoing method embodiment, and the first network node may correspond to the head node or the transit node <b>1</b> in the method <b>200</b>. If the first network node corresponds to the head node in the method <b>200</b>, the first outbound interface corresponds to the interface <b>2</b> of the head node in the method <b>200</b>, the first timestamp of each packet corresponds to the timestamp T<b>1</b> of each packet in the method <b>200</b>, and the second timestamp of each packet corresponds to the timestamp T<b>4</b> of each packet in the method <b>200</b>. If the first network node corresponds to the transit node <b>1</b> in the method <b>200</b>, the first outbound interface corresponds to the interface <b>2</b> of the transit node <b>1</b> in the method <b>200</b>, the first timestamp of each packet corresponds to the timestamp T<b>5</b> of each packet in the method <b>200</b>, and the second timestamp of each packet corresponds to the timestamp T<b>6</b> of each packet in the method <b>200</b>.</p><p id="p-0168" num="0167">In an implementation, when the indication information indicates that the in-situ flow detection is end-to-end per-packet in-situ flow detection and hop-by-hop per-packet in-situ flow detection, the method <b>300</b> further includes: The first network node receives, through the first outbound interface, each packet that is encapsulated with the first timestamp and that is from the first inbound interface; the first network node encapsulates the second timestamp of each packet into in-situ flow detection information of each received packet, where the second timestamp of each packet indicates a moment at which each packet is received through the first outbound interface; and the first network node sends each packet encapsulated with the first timestamp and the second timestamp to a second network node through the first outbound interface.</p><p id="p-0169" num="0168">In this case, the first network node may be the head node in the method <b>100</b> or the method <b>200</b>, the first inbound interface is the interface <b>1</b> of the head node in the method <b>100</b> or the method <b>200</b>, the first outbound interface is the interface <b>2</b> of the head node in the method <b>100</b> or the method <b>200</b>, the first timestamp of each packet corresponds to the timestamp T<b>1</b> of each packet in the method <b>100</b> or the method <b>200</b>, and the second timestamp of each packet corresponds to the timestamp T<b>2</b> in the method <b>100</b> or the method <b>200</b>. The second network node mentioned herein is a downstream node adjacent to the head node.</p><p id="p-0170" num="0169">In an implementation, the method <b>300</b> further includes: The first network node determines a transmission delay of each packet in the first network node based on the first timestamp of each packet and the second timestamp of each packet; and the first network node determines, based on the transmission delay of each packet in the first network node, a transmission delay of internal transmission of the first service flow in the first network node in the first in-situ flow detection period.</p><p id="p-0171" num="0170">In this case, the method <b>300</b> may be applied to the method <b>200</b> provided in the foregoing embodiment, and the first network node may correspond to the head node or the transit node <b>1</b> in the method <b>200</b>. If the first network node corresponds to the head node in the method <b>200</b>, the first outbound interface corresponds to the interface <b>2</b> of the head node in the method <b>200</b>, the first timestamp of each packet corresponds to the timestamp T<b>1</b> of each packet in the method <b>200</b>, and the second timestamp of each packet corresponds to the timestamp T<b>4</b> of each packet in the method <b>200</b>. If the first network node corresponds to the transit node <b>1</b> in the method <b>200</b>, the first outbound interface corresponds to the interface <b>2</b> of the transit node <b>1</b> in the method <b>200</b>, the first timestamp of each packet corresponds to the timestamp T<b>5</b> of each packet in the method <b>200</b>, and the second timestamp of each packet corresponds to the timestamp T<b>6</b> of each packet in the method <b>200</b>.</p><p id="p-0172" num="0171">In a possible implementation, when the indication information indicates that the in-situ flow detection is hop-by-hop per-packet in-situ flow detection, the method <b>300</b> further includes: The first network node receives, through the first outbound interface, each packet that is encapsulated with the first timestamp and that is from the first inbound interface; the first network node determines a second timestamp of each packet, where the second timestamp of each packet indicates a moment at which each packet is received through the first outbound interface; the first network node determines, based on the first timestamp carried in each packet and the second timestamp of each packet, a transmission delay of each packet in the first network node; and the first network node determines, based on the transmission delay of each packet in the first network node, a transmission delay of internal transmission of the first service flow in the first network node in the first in-situ flow detection period.</p><p id="p-0173" num="0172">In this case, for example, the first network node may correspond to the tail node in the method <b>200</b>, the first timestamp carried in each packet may correspond to the timestamp T<b>6</b> of each packet in the method <b>200</b>, and the second timestamp of each packet may correspond to the timestamp at which each packet is received through the outbound interface of the tail node in the method <b>200</b>.</p><p id="p-0174" num="0173">In an implementation, the method <b>300</b> further includes: The first network node sends, to a controller, a transmission delay of internal transmission of the first service flow in the first network node in the first in-situ flow detection period.</p><p id="p-0175" num="0174">In this case, the method <b>300</b> may be applied to the method <b>200</b> provided in the foregoing embodiment, and the first network node may correspond to the head node or the transit node <b>1</b> in the method <b>200</b>. The controller may correspond to the control management device in the method <b>200</b>.</p><p id="p-0176" num="0175">In an implementation, the transmission delay of internal transmission of the first service flow in the first network node in the first in-situ flow detection period includes any one or more of the maximum transmission delay of internal transmission of the first service flow in the first network node in the first in-situ flow detection period, the minimum transmission delay of internal transmission of the first service flow in the first network node in the first in-situ flow detection period, and the average transmission delay of internal transmission of the first service flow in the first network node in the first in-situ flow detection period.</p><p id="p-0177" num="0176">In an implementation, that the first network node receives each of the plurality of packets through a first inbound interface includes: the first network node receives, through the first inbound interface, each packet sent by a third network node, where the third network node is connected to the first inbound interface through a second outbound interface, each received packet carries a third timestamp, and the third timestamp in each packet is a moment at which the third network node receives each packet through the second outbound interface; and that the first network node encapsulates, into the in-situ flow detection information of each received packet, the first timestamp at which each packet is received through the first inbound interface includes: the first network node updates the third timestamp in each packet to the first timestamp.</p><p id="p-0178" num="0177">In this case, the method <b>300</b> may be applied to the method <b>200</b> provided in the foregoing embodiment, and the first network node may correspond to the transit node <b>1</b> or the tail node in the method <b>200</b>. When the first network node corresponds to the transit node <b>1</b> in the method <b>200</b>, the first inbound interface corresponds to the interface <b>1</b> of the transit node <b>1</b> in the method <b>200</b>, the third network device may correspond to the head node in the method <b>200</b>, the second outbound interface corresponds to the interface <b>2</b> of the head node in the method <b>200</b>, and the first timestamp of each packet corresponds to the timestamp T<b>5</b> of each packet in the method <b>200</b>. The third timestamp of each packet corresponds to the timestamp T<b>4</b> of each packet in the method <b>200</b>. When the first network node corresponds to the tail node in the method <b>200</b>, the first inbound interface corresponds to an interface for interaction between the tail node and the transit node <b>1</b> in the method <b>200</b>, the third network device may correspond to the transit node <b>1</b> in the method <b>200</b>, the second outbound interface is corresponding to the interface <b>2</b> of the transit node <b>1</b> in the method <b>200</b>, and the first timestamp of each packet is corresponding to a timestamp at which each packet is received through the tail node in the method <b>200</b>. The third timestamp of each packet corresponds to the timestamp T<b>6</b> of each packet in the method <b>200</b>.</p><p id="p-0179" num="0178">In an implementation, the method <b>300</b> further includes: The first network node determines a link transmission delay of each packet between the third network node and the first network node based on the third timestamp carried in each packet and the first timestamp of each packet; and the first network node determines, based on the link transmission delay of each packet between the third network node and the first network node, a link transmission delay of the first service flow between the third network node and the first network node in the first in-situ flow detection period.</p><p id="p-0180" num="0179">In an implementation, the method <b>300</b> further includes: The first network node sends, to a controller, the link transmission delay of the first service flow between the third network node and the first network node in the first in-situ flow detection period.</p><p id="p-0181" num="0180">In an implementation, the link transmission delay of the first service flow between the third network node and the first network node in the first in-situ flow detection period includes any one or more of a maximum link transmission delay of the first service flow between the third network node and the first network node in the first in-situ flow detection period, a minimum link transmission delay of the first service flow between the third network node and the first network node in the first in-situ flow detection period, and an average link transmission delay of the first service flow between the third network node and the first network node in the first in-situ flow detection period.</p><p id="p-0182" num="0181"><figref idref="DRAWINGS">FIG. <b>7</b></figref> is a schematic flowchart of the in-situ flow detection method according to an embodiment. The method shown in <figref idref="DRAWINGS">FIG. <b>7</b></figref> may be performed, for example, by a first network node in a detection domain. The first network node may perform the following S<b>401</b> to S<b>403</b> for each of a plurality of packets in a first service flow received in a first in-situ flow detection period.</p><p id="p-0183" num="0182">S<b>401</b>: The first network node receives each of the plurality of packets, where in-situ flow detection information of each of the plurality of packets carries a first timestamp, and the first timestamp of each packet indicates a moment at which a head node in the detection domain receives each packet.</p><p id="p-0184" num="0183">S<b>402</b>: The first network node determines a second timestamp of each of the plurality of packets, where the second timestamp of each packet indicates a moment at which each packet is received through an outbound interface of the first network node.</p><p id="p-0185" num="0184">S<b>403</b>: The first network node determines, based on the first timestamp carried in each packet and the second timestamp of each packet, an end-to-end transmission delay of the first service flow from the head node to the first network node in the first in-situ flow detection period.</p><p id="p-0186" num="0185">The method <b>400</b> may be applied to the method <b>100</b> provided in the foregoing embodiment and is configured to perform steps performed by the transit node <b>1</b> or the tail node in the method <b>100</b>.</p><p id="p-0187" num="0186">When the method <b>400</b> is used to perform the steps performed by the tail node in the method <b>100</b>, the first timestamp of each packet corresponds to the timestamp T<b>1</b> of each packet in the method <b>100</b>, and the second timestamp of each packet corresponds to the timestamp T<b>2</b> of each packet in the method <b>100</b>. When the method <b>400</b> is used to perform the steps performed by the transit node <b>1</b> in the method <b>100</b>, the first timestamp of each packet corresponds to the timestamp T<b>1</b> of each packet in the method <b>100</b>, and the second timestamp of each packet corresponds to the timestamp T<b>3</b> of each packet in the method <b>100</b>.</p><p id="p-0188" num="0187">In an implementation, the in-situ flow detection information further includes indication information, and the indication information indicates that the in-situ flow detection is end-to-end per-packet in-situ flow detection.</p><p id="p-0189" num="0188">In an implementation, the plurality of packets includes a first packet, the first packet includes first iFIT in-situ flow detection information, the first timestamp is located in a first flow instruction extension header FIEH in the first iFIT in-situ flow detection information, the iFIT in-situ flow detection information further includes indication information, and the indication information indicates that the in-situ flow detection is end-to-end per-packet in-situ flow detection.</p><p id="p-0190" num="0189">In an implementation, that the first network node determines, based on the first timestamp carried in each packet and the second timestamp of each packet, the end-to-end transmission delay of the first service flow from the head node to the first network node in the first in-situ flow detection period includes: The first network node determines, based on the first timestamp carried in each packet and the second timestamp of each packet, an end-to-end transmission delay of each packet from the head node to the first network node; and the first network node determines, based on the end-to-end transmission delay of each packet from the head node to the first network node, the end-to-end transmission delay of the first service flow from the head node to the first network node in the first in-situ flow detection period. In an implementation, the method <b>400</b> further includes: The first network node sends, to a controller, the end-to-end transmission delay of the first service flow from the head node to the first network node in the first in-situ flow detection period. The controller mentioned herein may correspond to the control management device in the method <b>100</b>.</p><p id="p-0191" num="0190">In an implementation, the end-to-end transmission delay of the first service flow from the head node to the first network node in the first in-situ flow detection period includes any one or more of the maximum end-to-end transmission delay of the first service flow from the head node to the first network node in the first in-situ flow detection period, the minimum end-to-end transmission delay of the first service flow from the head node to the first network node in the first in-situ flow detection period, and the average end-to-end transmission delay of the first service flow from the head node to the first network node in the first in-situ flow detection period.</p><p id="p-0192" num="0191">An embodiment further provides an in-situ flow detection method <b>500</b>. <figref idref="DRAWINGS">FIG. <b>8</b></figref> is a schematic flowchart of the in-situ flow detection method according to an embodiment. The method shown in <figref idref="DRAWINGS">FIG. <b>8</b></figref> includes, for example, the following S<b>501</b> and S<b>502</b>.</p><p id="p-0193" num="0192">S<b>501</b>: A controller receives a transmission delay that is of a first service flow in a detection domain in a first in-situ flow detection period and that is sent by a first network node, where the transmission delay of the first service flow in the detection domain includes any one or more of a maximum transmission delay, a minimum transmission delay, and an average transmission delay.</p><p id="p-0194" num="0193">S<b>502</b>: The controller saves the received transmission delay.</p><p id="p-0195" num="0194">For example, the method <b>500</b> may be applied to the method <b>100</b> or the method <b>200</b> provided in the foregoing embodiments, and is used to receive the transmission delays reported by the transit node <b>1</b> and the tail node in the method <b>100</b>, or is used to receive the transmission delays reported by the head node, the transit node <b>1</b>, and the tail node in the method <b>200</b>. After saving the received transmission delay, for example, the controller may perform analysis and processing based on the saved transmission delay, to determine network performance of the detection domain.</p><p id="p-0196" num="0195">In an implementation, the transmission delay of the first service flow in the detection domain includes an end-to-end transmission delay from a head node in the detection domain to the first network node.</p><p id="p-0197" num="0196">In this case, for example, the first network node may correspond to the transit node <b>1</b> or the tail node in the method <b>100</b>.</p><p id="p-0198" num="0197">In an implementation, the transmission delay of the first service flow in the detection domain includes a transmission delay of the first service flow in the first network node.</p><p id="p-0199" num="0198">In this case, for example, the first network node may correspond to the head node, the transit node <b>1</b>, or the tail node in the method <b>200</b>.</p><p id="p-0200" num="0199">In an implementation, the transmission delay of the first service flow in the detection domain includes a transmission delay of the first service flow between the first network node and a second network node, where the first network node is a transit node or a tail node in the detection domain, and the second network node is an upstream node of the first network node.</p><p id="p-0201" num="0200">In this case, for example, the first network node may correspond to the transit node <b>1</b> in the method <b>100</b>, and the second network node may correspond to the head node in the method <b>100</b>. Alternatively, the first network node may correspond to the tail node in the method <b>100</b>, and the second network node may correspond to the head node in the method <b>100</b>. Alternatively, the first network node may correspond to the transit node <b>1</b> in the method <b>200</b>, and the second network node may correspond to the head node in the method <b>200</b>. Alternatively, for example, the first network node may correspond to the tail node in the method <b>200</b>, and the second network node may correspond to the transit node <b>1</b> in the method <b>200</b>.</p><p id="p-0202" num="0201">In an implementation, the transmission delay of the first service flow in the detection domain includes a link transmission delay of the first service flow between the first network node and the second network node, where the second network node is an upstream node adjacent to the first network node.</p><p id="p-0203" num="0202">If the head node and the transit node <b>1</b> in the method <b>100</b> are adjacent nodes, for example, the first network node may correspond to the tail node in the method <b>100</b>, and the second network node may correspond to the head node in the method <b>100</b>. If the transit node <b>1</b> and the tail node in the method <b>100</b> are adjacent nodes, for example, the first network node may correspond to the tail node in the method <b>100</b>, and the second network node may correspond to the head node in the method <b>100</b>. If the head node and the transit node <b>1</b> in the method <b>200</b> are adjacent nodes, for example, the first network node may correspond to the transit node <b>1</b> in the method <b>200</b>, and the second network node may correspond to the head node in the method <b>200</b>. If the transit node <b>1</b> and the tail node in the method <b>200</b> are adjacent nodes, the first network node may correspond to the tail node in the method <b>200</b>, and the second network node may correspond to the transit node <b>1</b> in the method <b>200</b>.</p><p id="p-0204" num="0203">In addition, an embodiment may further provide a first network node <b>900</b>. <figref idref="DRAWINGS">FIG. <b>9</b></figref> is a schematic diagram of a structure of the first network node according to an embodiment. The first network node <b>900</b> includes a transceiver unit <b>901</b> and a processing unit <b>902</b>.</p><p id="p-0205" num="0204">The transceiver unit <b>901</b> is configured to perform receiving and sending operations performed by the first network node in the method <b>600</b>; and the processing unit <b>902</b> is configured to perform an operation other than the receiving and sending operations performed by the first network node in the method <b>600</b>. For example, the transceiver unit <b>901</b> is configured to receive each of a plurality of packets through a first inbound interface; and the processing unit <b>902</b> is configured to: encapsulate, into in-situ flow detection information of each received packet, a first timestamp of each packet received through the first inbound interface, where the first timestamp of each packet indicates a moment at which the first network node receives each packet through the first inbound interface, and forward each packet encapsulated with the first timestamp to a first outbound interface.</p><p id="p-0206" num="0205">Alternatively, the transceiver unit <b>901</b> is configured to perform receiving and sending operations performed by the first network node in the method <b>700</b>; and the processing unit <b>902</b> is configured to perform an operation other than the receiving and sending operations performed by the first network node in the method <b>700</b>. For example, the transceiver unit <b>901</b> is configured to receive each of the plurality of packets, where each of the plurality of packets carries a first timestamp, and the first timestamp of each packet indicates a moment at which a head node in the detection domain receives each packet; and the processing unit <b>902</b> is configured to: determine a second timestamp of each of the plurality of packets, where the second timestamp of each packet indicates a moment at which each packet is received through an outbound interface of the first network node; and determine, based on the first timestamp carried in each packet and the second timestamp of each packet, an end-to-end transmission delay of the first service flow from the head node to the first network node in the first in-situ flow detection period.</p><p id="p-0207" num="0206">In addition, an embodiment may further provide a controller <b>1000</b>, as shown in <figref idref="DRAWINGS">FIG. <b>10</b></figref>. <figref idref="DRAWINGS">FIG. <b>10</b></figref> is a schematic diagram of a structure of a controller according to an embodiment. The controller <b>1000</b> includes a transceiver unit <b>1001</b> and a processing unit <b>1002</b>. The transceiver unit <b>1001</b> is configured to perform receiving and sending operations performed by the controller in the foregoing embodiments. The transceiver unit <b>1001</b> is configured to perform receiving and sending operations performed by the controller in the method <b>800</b>; and the processing unit <b>1002</b> is configured to perform an operation other than the receiving and sending operations performed by the controller in the method <b>800</b>. For example, the transceiver unit <b>1001</b> is configured to receive a transmission delay that is of a first service flow in a detection domain in a first in-situ flow detection period and that is sent by a first network node, where the transmission delay of the first service flow in the detection domain includes any one or more of a maximum transmission delay, a minimum transmission delay, and an average transmission delay; and the processing unit <b>1002</b> is configured to store the received transmission delay.</p><p id="p-0208" num="0207">In addition, an embodiment may further provide a first network node <b>1100</b>. <figref idref="DRAWINGS">FIG. <b>11</b></figref> is a schematic diagram of a structure of the first network node according to an embodiment. The first network node <b>1100</b> includes a communication interface <b>1101</b> and a processor <b>1102</b> connected to the communication interface <b>1101</b>.</p><p id="p-0209" num="0208">The communication interface <b>1101</b> is configured to perform receiving and sending operations performed by the first network node in the method <b>600</b>; and the processor <b>1102</b> is configured to perform an operation other than the receiving and sending operations performed by the first network node in the method <b>600</b>. For example, the communication interface <b>1101</b> includes a first inbound interface and a first outbound interface, where the first inbound interface is configured to receive each of a plurality of packets; and the processor <b>1102</b> is configured to: encapsulate, into in-situ flow detection information of each received packet, a first timestamp of each packet received through the first inbound interface, where the first timestamp of each packet indicates a moment at which the first network node receives each packet through the first inbound interface; and forward each packet encapsulated with the first timestamp to a first outbound interface. Correspondingly, the first outbound interface is configured to receive each packet encapsulated with the first timestamp.</p><p id="p-0210" num="0209">Alternatively, the communication interface <b>1101</b> is configured to perform receiving and sending operations performed by the first network node in the method <b>700</b>; and the processor <b>1102</b> is configured to perform an operation other than the receiving and sending operations performed by the first network node in the method <b>700</b>. For example, the communication interface <b>1101</b> includes an inbound interface and an outbound interface. The inbound interface is configured to receive each of the plurality of packets, where each of the plurality of packets carries a first timestamp, and the first timestamp of each packet indicates a moment at which a head node in the detection domain receives each packet; the outbound interface is configured to receive each packet from the inbound interface; and the processor <b>1102</b> is configured to: determine a second timestamp of each of the plurality of packets, where the second timestamp of each packet indicates a moment at which each packet is received through an outbound interface of the first network node; and determine, based on the first timestamp carried in each packet and the second timestamp of each packet, an end-to-end transmission delay of the first service flow from the head node to the first network node in the first in-situ flow detection period.</p><p id="p-0211" num="0210">In addition, an embodiment may further provide a controller <b>1200</b>. <figref idref="DRAWINGS">FIG. <b>12</b></figref> is a schematic diagram of a structure of the controller according to an embodiment. The controller <b>1200</b> includes a communication interface <b>1201</b> and a processor <b>1202</b> connected to the communication interface <b>1201</b>. The communication interface <b>1201</b> is configured to perform receiving and sending operations performed by the controller in the method <b>800</b>; and the processor <b>1202</b> is configured to perform an operation other than the receiving and sending operations performed by the controller in the method <b>800</b>. For example, the communication interface <b>1201</b> is configured to receive a transmission delay that is of a first service flow in a detection domain in a first in-situ flow detection period and that is sent by a first network node, where the transmission delay of the first service flow in the detection domain includes any one or more of a maximum transmission delay, a minimum transmission delay, and an average transmission delay; and the processor <b>1202</b> is configured to store the received transmission delay.</p><p id="p-0212" num="0211">In addition, an embodiment may further provide a first network node <b>1300</b>. <figref idref="DRAWINGS">FIG. <b>13</b></figref> is a schematic diagram of a structure of the first network node according to an embodiment. The first network node <b>1300</b> includes a memory <b>1301</b> and a processor <b>1302</b>. The memory <b>1301</b> is configured to store program code; and the processor <b>1302</b> is configured to run instructions in the program code, so that the first network node <b>1300</b> performs the steps performed by the first network node in the method <b>600</b>, or the first network node <b>1300</b> performs the steps performed by the first network node in the method <b>700</b>.</p><p id="p-0213" num="0212">In addition, an embodiment may further provide a controller <b>1400</b>. <figref idref="DRAWINGS">FIG. <b>14</b></figref> is a schematic diagram of a structure of the controller according to an embodiment. The controller <b>1400</b> includes a memory <b>1401</b> and a processor <b>1402</b>. The memory <b>1401</b> is configured to store program code; and the processor <b>1402</b> is configured to run instructions in the program code, so that the controller <b>1400</b> performs the steps performed by the controller in the method <b>800</b>.</p><p id="p-0214" num="0213">In addition, an embodiment may further provide a communication system. The communication system includes a first network node <b>1300</b> and a controller <b>1400</b>. For the first network node <b>1300</b> and the controller <b>1400</b>, refer to related descriptions in the foregoing embodiments. Details are not described herein again.</p><p id="p-0215" num="0214">In the embodiments and accompanying drawings, the terms &#x201c;first&#x201d;, &#x201c;second&#x201d;, &#x201c;third&#x201d;, &#x201c;fourth&#x201d;, and so on (if existent) are intended to distinguish between similar objects but do not necessarily indicate an order or sequence. It should be understood that the data termed in such a way are interchangeable in proper circumstances so that the embodiments described herein can be implemented in other orders than the order illustrated or described herein. Moreover, the terms &#x201c;include&#x201d;, &#x201c;contain&#x201d; and any other variants mean to cover the non-exclusive inclusion, for example, a process, method, system, product, or device that includes a list of steps or units is not necessarily limited to those units but may include other units not expressly listed or inherent to such a process, method, system, product, or device.</p><p id="p-0216" num="0215">It may be clearly understood by a person skilled in the art that, for the purpose of convenient and brief description, for a detailed working process of the foregoing system, apparatus, and unit, refer to a corresponding process in the foregoing method embodiments, and details are not described herein again.</p><p id="p-0217" num="0216">In several embodiments, it should be understood that the system, apparatus, and method may be implemented in other manners. For example, the described apparatus embodiment is merely an example. For example, division into the units is merely logical service division and may be other division in an actual implementation. For example, a plurality of units or components may be combined or integrated into another system, or some features may be ignored or not performed. In addition, the displayed or discussed mutual couplings or direct couplings or communication connections may be implemented by using some interfaces. The indirect couplings or communication connections between the apparatuses or units may be implemented in electronic, mechanical, or other forms.</p><p id="p-0218" num="0217">The units described as separate parts may or may not be physically separate, and parts displayed as units may or may not be physical units, in other words, may be located in one position, or may be distributed on a plurality of network units. Some or all of the units may be selected based on actual requirements to achieve the objectives of the solutions of embodiments.</p><p id="p-0219" num="0218">In addition, service units in the embodiments may be integrated into one processing unit, or each of the units may exist alone physically, or two or more units may be integrated into one unit. The integrated unit may be implemented in a form of hardware or may be implemented in a form of a software service unit.</p><p id="p-0220" num="0219">When the integrated unit is implemented in the form of a software service unit and sold or used as an independent product, the integrated unit may be stored in a non-transitory computer-readable storage medium. Based on such an understanding, the embodiments may be implemented in a form of a software product. The computer software product is stored in a storage medium and includes several instructions for instructing a computer device (which may be a personal computer, a server, a network device, or the like) to perform all or some of the steps of the method in the embodiments. The storage medium includes any medium that can store program code, such as a USB flash drive, a removable hard disk, a read-only memory (ROM), a random access memory (RAM), a magnetic disk, or an optical disc.</p><p id="p-0221" num="0220">Persons skilled in the art should be aware that in the foregoing one or more examples, the services described in the embodiments may be implemented by using hardware, software, firmware, or any combination thereof. When is implemented by using software, the services may be stored in a non-transitory computer-readable medium or transmitted as one or more instructions or code in the non-transitory computer-readable medium. The non-transitory computer-readable medium includes a computer storage medium. The computer storage medium may be any available medium accessible to a general-purpose or special-purpose computer.</p><p id="p-0222" num="0221">The objectives, solutions, and beneficial effects have been further described in detail in the foregoing implementations. It should be understood that the foregoing descriptions are merely implementations of the embodiments.</p><p id="p-0223" num="0222">The foregoing embodiments are merely intended for describing the solutions, but are not limiting. Although described in detail with reference to the foregoing embodiments, persons of ordinary skill in the art should understand that they may still make modifications to the solutions described in the foregoing embodiments or make equivalent replacements to some features thereof, without departing from the scope of the embodiments.</p><?detailed-description description="Detailed Description" end="tail"?></description><claims id="claims"><claim id="CLM-00001" num="00001"><claim-text><b>1</b>. A first network node for in-situ flow detection, comprising:<claim-text>a memory configured to store instructions; and</claim-text><claim-text>a processor coupled to the memory, wherein when the instructions are executed by the processor, the execution of the instructions cause the first network node to:</claim-text><claim-text>perform, in a detection domain, the following operations on each of a plurality of packets in a first service flow received in a first in-situ flow detection period:</claim-text><claim-text>receiving each of the plurality of packets through a first inbound interface;</claim-text><claim-text>encapsulating, into in-situ flow detection information of each received packet, a first timestamp at which each packet is received through the first inbound interface, wherein the first timestamp of each packet indicates a moment at which the first network node receives each packet through the first inbound interface; and</claim-text><claim-text>forwarding, to a first outbound interface, each packet encapsulated with the first timestamp.</claim-text></claim-text></claim><claim id="CLM-00002" num="00002"><claim-text><b>2</b>. The first network node according to <claim-ref idref="CLM-00001">claim 1</claim-ref>, wherein the in-situ flow detection information further comprises indication information, and the indication information indicates that the in-situ flow detection is end-to-end per-packet in-situ flow detection and/or hop-by-hop per-packet in-situ flow detection.</claim-text></claim><claim id="CLM-00003" num="00003"><claim-text><b>3</b>. The first network node according to <claim-ref idref="CLM-00001">claim 1</claim-ref>, wherein the in-situ flow detection information is iFIT in-situ flow detection information.</claim-text></claim><claim id="CLM-00004" num="00004"><claim-text><b>4</b>. The first network node according to <claim-ref idref="CLM-00001">claim 1</claim-ref>, wherein the instructions executed by the processor further cause the first network node to perform the following operations:<claim-text>receiving, through the first outbound interface, each packet that is encapsulated with the first timestamp and that is from the first inbound interface;</claim-text><claim-text>updating each first timestamp of the plurality of packets to a second timestamp of each packet, wherein the second timestamp of each packet indicates a moment at which each packet is received through the first outbound interface; and</claim-text><claim-text>sending, to a second network node through the first outbound interface, each packet encapsulated with the second timestamp.</claim-text></claim-text></claim><claim id="CLM-00005" num="00005"><claim-text><b>5</b>. The first network node according to <claim-ref idref="CLM-00001">claim 1</claim-ref>, wherein the instructions executed by the processor further cause the first network node to perform the following operations:<claim-text>receiving, through the first outbound interface, each packet that is encapsulated with the first timestamp and that is from the first inbound interface;</claim-text><claim-text>encapsulating the second timestamp of each of the plurality of packets into received in-situ flow detection information of each packet, wherein the second timestamp of each packet indicates a moment at which each packet is received through the first outbound interface; and</claim-text><claim-text>sending, to a second network node through the first outbound interface, each packet encapsulated with the first timestamp and the second timestamp.</claim-text></claim-text></claim><claim id="CLM-00006" num="00006"><claim-text><b>6</b>. The first network node according to <claim-ref idref="CLM-00004">claim 4</claim-ref>, wherein the instructions executed by the processor further cause the first network node to perform the following operations:<claim-text>determining, based on the first timestamp carried in each packet and the second timestamp of each packet, a transmission delay of each packet in the first network node; and</claim-text><claim-text>determining, based on the transmission delay of each packet in the first network node, a transmission delay of internal transmission of the first service flow in the first network node in the first in-situ flow detection period.</claim-text></claim-text></claim><claim id="CLM-00007" num="00007"><claim-text><b>7</b>. The first network node according to <claim-ref idref="CLM-00001">claim 1</claim-ref>, wherein the instructions executed by the processor further cause the first network node to perform the following operations:<claim-text>receiving, through the first outbound interface, each packet that is encapsulated with the first timestamp and that is from the first inbound interface;</claim-text><claim-text>determining a second timestamp of each packet, wherein the second timestamp of each packet indicates a moment at which each packet is received through the first outbound interface;</claim-text><claim-text>determining, based on the first timestamp carried in each packet and the second timestamp of each packet, a transmission delay of each packet in the first network node; and</claim-text><claim-text>determining, based on the transmission delay of each packet in the first network node, a transmission delay of internal transmission of the first service flow in the first network node in the first in-situ flow detection period.</claim-text></claim-text></claim><claim id="CLM-00008" num="00008"><claim-text><b>8</b>. The first network node according to <claim-ref idref="CLM-00006">claim 6</claim-ref>, wherein the instructions executed by the processor further cause the first network node to perform the following operations:<claim-text>sending, to a controller, a transmission delay of internal transmission of the first service flow in the first network node in the first in-situ flow detection period.</claim-text></claim-text></claim><claim id="CLM-00009" num="00009"><claim-text><b>9</b>. The first network node according to <claim-ref idref="CLM-00006">claim 6</claim-ref>, wherein the transmission delay of internal transmission of the first service flow in the first network node in the first in-situ flow detection period comprises one or more of the following:<claim-text>a maximum transmission delay of internal transmission of the first service flow in the first network node in the first in-situ flow detection period, a minimum transmission delay of internal transmission of the first service flow in the first network node in the first in-situ flow detection period, and an average transmission delay of internal transmission of the first service flow in the first network node in the first in-situ flow detection period.</claim-text></claim-text></claim><claim id="CLM-00010" num="00010"><claim-text><b>10</b>. The first network node according to <claim-ref idref="CLM-00001">claim 1</claim-ref>, wherein the instructions executed by the processor further cause the first network node to perform the following operations:<claim-text>receiving, through the first inbound interface, each packet sent by a third network node, wherein the third network node is connected to the first inbound interface through a second outbound interface, each received packet carries a third timestamp, and the third timestamp in each packet is a moment at which the third network node receives each packet through the second outbound interface; and</claim-text><claim-text>updating the third timestamp in each packet to the first timestamp.</claim-text></claim-text></claim><claim id="CLM-00011" num="00011"><claim-text><b>11</b>. The first network node according to <claim-ref idref="CLM-00010">claim 10</claim-ref>, wherein the instructions executed by the processor further cause the first network node to perform the following operations:<claim-text>determining, based on the third timestamp carried in each packet and the first timestamp of each packet, a link transmission delay of each packet between the third network node and the first network node; and</claim-text><claim-text>determining, based on the link transmission delay of each packet between the third network node and the first network node, a link transmission delay of the first service flow between the third network node and the first network node in the first in-situ flow detection period.</claim-text></claim-text></claim><claim id="CLM-00012" num="00012"><claim-text><b>12</b>. The first network node according to <claim-ref idref="CLM-00011">claim 11</claim-ref>, wherein the instructions executed by the processor further cause the first network node to perform the following operations:<claim-text>sending, to a controller, the link transmission delay of the first service flow between the third network node and the first network node in the first in-situ flow detection period.</claim-text></claim-text></claim><claim id="CLM-00013" num="00013"><claim-text><b>13</b>. The first network node according to <claim-ref idref="CLM-00011">claim 11</claim-ref>, wherein the link transmission delay of the first service flow between the third network node and the first network node in the first in-situ flow detection period comprises any one or more of the following:<claim-text>a maximum link transmission delay of the first service flow between the third network node and the first network node in the first in-situ flow detection period, a minimum link transmission delay of the first service flow between the third network node and the first network node in the first in-situ flow detection period, and an average link transmission delay of the first service flow between the third network node and the first network node in the first in-situ flow detection period.</claim-text></claim-text></claim><claim id="CLM-00014" num="00014"><claim-text><b>14</b>. A first network node for in-situ flow detection, comprising:<claim-text>a memory configured to store instructions;</claim-text><claim-text>a processor coupled to the memory, wherein when the instructions are executed by the processor, the execution of the instructions cause the first network node to:</claim-text><claim-text>perform, in a detection domain, the following operations on each of a plurality of packets in a first service flow received in a first in-situ flow detection period:</claim-text><claim-text>receiving each of the plurality of packets, wherein in-situ flow detection information of each of the plurality of packets carries a first timestamp, and the first timestamp of each packet indicates a moment at which a head node in the detection domain receives each packet;</claim-text><claim-text>determining a second timestamp of each of the plurality of packets, wherein the second timestamp of each packet indicates a moment at which each packet is received through an outbound interface of the first network node; and</claim-text><claim-text>determining, based on the first timestamp carried in each packet and the second timestamp of each packet, an end-to-end transmission delay of the first service flow from the head node to the first network node in the first in-situ flow detection period.</claim-text></claim-text></claim><claim id="CLM-00015" num="00015"><claim-text><b>15</b>. The first network node according to <claim-ref idref="CLM-00014">claim 14</claim-ref>, wherein the in-situ flow detection information further comprises indication information, and the indication information indicates that the in-situ flow detection is end-to-end per-packet in-situ flow detection.</claim-text></claim><claim id="CLM-00016" num="00016"><claim-text><b>16</b>. The first network node according to <claim-ref idref="CLM-00014">claim 14</claim-ref>, wherein the instructions executed by the processor; further cause the first network node to perform the following operations:<claim-text>determining, based on the first timestamp carried in each packet and the second timestamp of each packet, an end-to-end transmission delay of each packet from the head node to the first network node; and</claim-text><claim-text>determining, based on the end-to-end transmission delay of each packet from the head node to the first network node, an end-to-end transmission delay of the first service flow from the head node to the first network node in the first in-situ flow detection period.</claim-text></claim-text></claim><claim id="CLM-00017" num="00017"><claim-text><b>17</b>. A controller for in-situ flow detection, comprising:<claim-text>a memory, configured to store instructions;</claim-text><claim-text>a processor coupled to the memory, wherein when the instructions are executed by the processor, the executed instructions cause the first network node to:</claim-text><claim-text>receive a transmission delay that is of a first service flow in a detection domain in a first in-situ flow detection period and that is sent by a first network node, wherein the transmission delay of the first service flow in the detection domain comprises any one or more of a maximum transmission delay, a minimum transmission delay, and an average transmission delay; and</claim-text><claim-text>save the received transmission delay.</claim-text></claim-text></claim><claim id="CLM-00018" num="00018"><claim-text><b>18</b>. The controller according to <claim-ref idref="CLM-00017">claim 17</claim-ref>, wherein the transmission delay of the first service flow in the detection domain comprises:<claim-text>an end-to-end transmission delay from a head node in the detection domain to the first network node.</claim-text></claim-text></claim><claim id="CLM-00019" num="00019"><claim-text><b>19</b>. The controller according to <claim-ref idref="CLM-00018">claim 18</claim-ref>, wherein the transmission delay of the first service flow in the detection domain comprises:<claim-text>a transmission delay of the first service flow in the first network node.</claim-text></claim-text></claim><claim id="CLM-00020" num="00020"><claim-text><b>20</b>. The controller according to <claim-ref idref="CLM-00018">claim 18</claim-ref>, wherein the transmission delay of the first service flow in the detection domain comprises:<claim-text>a transmission delay of the first service flow between the first network node and a second network node, wherein the first network node is a transit node or a tail node in the detection domain, and the second network node is an upstream node of the first network node.</claim-text></claim-text></claim></claims></us-patent-application>